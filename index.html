<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emas Binshiman | Premium Gold Investment</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts: Inter (Closest free web-font to Apple's San Francisco) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- TradingView Script -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>


<!-- Tailwind Configuration for Apple-like Aesthetics -->
<script>
tailwind.config = {
theme: {
extend: {
fontFamily: {
sans: ['Inter', 'sans-serif'],
},
colors: {
gold: {
50: '#fffbf0',
100: '#fef5cd',
200: '#fde89b',
300: '#fcd56d',
400: '#fbbf46',
500: '#f59e0b', // Base Gold
600: '#d97706',
700: '#b45309',
800: '#92400e',
900: '#78350f',
},
dark: {
900: '#0a0a0a', // True Deep Black Background (Premium feel)
800: '#1c1c1e', // Apple Dark Gray Card/Secondary
}
},
animation: {
'float': 'float 6s ease-in-out infinite',
'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
'gold-pulse': 'goldPulse 4s ease-in-out infinite', // New subtle pulse for gradient
},
keyframes: {
float: {
'0%, 100%': { transform: 'translateY(0)' },
'50%': { transform: 'translateY(-10px)' },
},
goldPulse: { // Subtle animation for the hero gradient text
'0%': { opacity: 1, transform: 'scale(1)' },
'50%': { opacity: 0.95, transform: 'scale(1.01)' },
'100%': { opacity: 1, transform: 'scale(1)' },
}
}
}
}
}
</script>

<style>
/* Apple-style smooth scroll & base styles */
body {
color: #1d1d1f; 
-webkit-font-smoothing: antialiased;
/* Added transition for smoother theme change */
transition: background-color 0.3s, color 0.3s; 
}

/* Glassmorphism Utilities (Responsive to Dark Mode) */
.glass {
background: rgba(255, 255, 255, 0.75);
backdrop-filter: blur(24px);
-webkit-backdrop-filter: blur(24px);
border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}

.dark .glass {
background: rgba(28, 28, 30, 0.85); /* dark-800 */
backdrop-filter: blur(24px);
-webkit-backdrop-filter: blur(24px);
border-bottom: 1px solid rgba(255, 255, 255, 0.15); 
}

/* Scroll Reveal: Sophisticated cubic-bezier for a smooth, high-end feel */
.reveal {
opacity: 0;
transform: translateY(30px) scale(0.98);
transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother, professional curve */
}

.reveal.active {
opacity: 1;
transform: translateY(0) scale(1);
}

.reveal.delay-100 { transition-delay: 0.1s; }
.reveal.delay-200 { transition-delay: 0.2s; }
.reveal.delay-300 { transition-delay: 0.3s; }
.reveal.delay-400 { transition-delay: 0.4s; }


/* Hide Scrollbar for clean look */
.no-scrollbar::-webkit-scrollbar {
display: none;
}
.no-scrollbar {
-ms-overflow-style: none;
scrollbar-width: none;
}

/* Custom class for Apple-style product blocks */
.product-showcase-block {
    min-height: 700px;
}

/* Custom style for the gradient animated hero text */
.animated-hero-text {
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
    animation: goldPulse 4s ease-in-out infinite;
    /* Initial state set by Tailwind classes */
}
</style>
</head>
<!-- The body now correctly uses Tailwind's bg-gray-100 and dark:bg-dark-900 for full page theme control -->
<body class="overflow-x-hidden bg-gray-100 dark:bg-dark-900">

<!-- NAVIGATION (FIXED & THEMED) -->
<nav class="fixed w-full z-50 glass transition-all duration-300" id="navbar">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<!-- Logo (Optimized with hover transition) -->
<div class="flex-shrink-0 flex items-center gap-2 cursor-pointer transition-transform duration-300 hover:scale-[1.03]" onclick="window.scrollTo(0,0)">
<div class="w-8 h-8 bg-gradient-to-br from-gold-300 to-gold-600 rounded-lg flex items-center justify-center shadow-lg">
<i data-lucide="gem" class="text-white w-5 h-5"></i>
</div>
<span class="font-semibold text-xl tracking-tight text-gray-900 dark:text-gray-50">Binshiman</span>
</div>

<!-- Desktop Menu (Optimized with smooth color transitions) -->
<div class="hidden md:flex space-x-8 items-center">
<a href="#market" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gold-600 transition-colors">Live Market</a>
<a href="#collection" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gold-600 transition-colors">Collection</a>
<a href="#investment" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gold-600 transition-colors">Career</a>

<!-- Live Traffic Indicator (Optimized with hover transition) -->
<div class="flex items-center gap-2 bg-gray-100 dark:bg-dark-900 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-md">
<span class="relative flex h-2 w-2">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
</span>
<span class="text-xs font-semibold text-gray-500 dark:text-gray-400" id="live-visitors">124 Live</span>
</div>
</div>

<!-- Icons -->
<div class="flex items-center gap-4">
<!-- DARK MODE TOGGLE BUTTON (Optimized with hover and smooth transition) -->
<button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors" aria-label="Toggle Dark Mode">
    <!-- Moon (Dark Mode Icon) -->
    <i data-lucide="moon" id="moon-icon" class="w-5 h-5 text-gray-700 dark:text-gold-300 hidden dark:block"></i>
    <!-- Sun (Light Mode Icon) -->
    <i data-lucide="sun" id="sun-icon" class="w-5 h-5 text-gray-700 dark:hidden"></i>
</button>

<!-- Cart Icon (Optimized with hover scale and count transition) -->
<button class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors hover:scale-[1.1]" onclick="toggleCart()">
<i data-lucide="shopping-bag" class="w-5 h-5 text-gray-700 dark:text-gray-300"></i>
<span id="cart-count" class="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center opacity-0 transition-opacity duration-300 scale-75">0</span>
</button>
<!-- Mobile Menu Button -->
<div class="md:hidden flex items-center">
<button id="mobile-menu-btn" class="p-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors">
<i data-lucide="menu" class="w-6 h-6"></i>
</button>
</div>
</div>
</div>
</div>

<!-- Mobile Menu (Optimized with transition) -->
<div id="mobile-menu" class="hidden md:hidden bg-white/95 dark:bg-dark-800/95 backdrop-blur-xl border-t border-gray-100 dark:border-gray-700 absolute w-full transition-opacity duration-300">
<div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
<a href="#market" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-900 transition-colors">Market</a>
<a href="#collection" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-900 transition-colors">Collection</a>
<a href="#investment" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-900 transition-colors">Career</a>
</div>
</div>
</nav>

<!-- HERO SECTION -->
<section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
<!-- Callout (Optimized with smooth transition) -->
<div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gold-50 border border-gold-200 text-gold-800 text-sm font-medium mb-8 reveal hover:ring-2 ring-gold-500 transition-all duration-300">
<i data-lucide="sparkles" class="w-4 h-4"></i> New Collection 2026
</div>

<!-- Text H1 (Optimized with reveal and animated gradient) -->
<h1 class="text-5xl md:text-7xl font-bold tracking-tight text-gray-900 dark:text-gray-50 mb-6 reveal delay-100">
Gold. <span class="animated-hero-text from-gold-500 to-gold-700">Redefined.</span>
</h1>

<p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500 dark:text-gray-400 reveal delay-200">
Real-time pricing. Premium savings security. Designed for the modern era.
</p>

<div class="mt-10 flex justify-center gap-4 reveal delay-300">
<!-- Primary Button (Optimized for clickability and scale feedback) -->
<a href="#collection" class="px-8 py-4 bg-gray-900 text-white rounded-full font-medium transition-all duration-300 hover:bg-black hover:scale-[1.05] shadow-lg shadow-gray-400/50 dark:shadow-none focus:outline-none focus:ring-4 ring-gold-500/50">
View Collection
</a>
<!-- Secondary Button (Optimized: Added subtle gold border on hover) -->
<a href="#market" class="px-8 py-4 bg-white dark:bg-dark-800 text-gray-900 dark:text-gray-50 border border-gray-200 dark:border-gray-700 rounded-full font-medium transition-all duration-300 hover:bg-gray-50 dark:hover:bg-dark-900 hover:scale-[1.05] hover:border-gold-500/50">
Track Prices
</a>
</div>
</div>

<!-- Decorative Background Elements -->
<div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full -z-10 opacity-30 pointer-events-none">
<div class="absolute top-[20%] left-[20%] w-72 h-72 bg-gold-300 rounded-full mix-blend-multiply filter blur-3xl animate-float"></div>
<div class="absolute top-[30%] right-[20%] w-72 h-72 bg-orange-200 rounded-full mix-blend-multiply filter blur-3xl animate-float" style="animation-delay: 2s"></div>
</div>
</section>

<!-- LIVE MARKET SECTION -->
<section id="market" class="py-20 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- Price Card (Optimized with border and shadow hover effects) -->
<div class="lg:col-span-1 bg-gray-50 dark:bg-dark-800 rounded-3xl p-8 border border-gray-100 dark:border-gray-700 shadow-xl reveal transition-all duration-500 hover:shadow-2xl hover:border-gold-300 dark:hover:border-gold-700">
<h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-50 mb-2">Live Gold Rate</h2>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Updates every 60 seconds • 24K 999.9</p>

<div class="flex items-baseline gap-2 mb-2 transition-all duration-300">
<span class="text-sm text-gray-500 dark:text-gray-400 font-medium">MYR</span>
<span id="current-price" class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-gold-300 animate-[goldPulse_2s_ease-out] transition-colors">...</span>
<span class="text-lg text-gray-400 dark:text-gray-500">/g</span>
</div>

<div id="price-change-container" class="flex items-center gap-2 text-green-600 font-medium mb-4">
<div id="loading-indicator" class="flex items-center gap-2 text-gold-600 dark:text-gold-400 font-medium text-sm">
<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Fetching Live Data...
</div>
<i id="trend-icon" data-lucide="trending-up" class="w-5 h-5 hidden transition-all duration-300"></i>
<span id="price-change" class="hidden">+0.00%</span>
<span class="text-gray-400 dark:text-gray-500 text-sm font-normal hidden" id="today-text">Today</span>
</div>

<p class="text-xs text-gray-400 dark:text-gray-500 mb-8" id="last-updated">Last update: Loading...</p>

<div class="space-y-4">
<div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700 transition-colors">
<span class="text-gray-500 dark:text-gray-400">Bid (Buy)</span>
<span class="font-medium text-gray-900 dark:text-gray-50" id="bid-price">...</span>
</div>
<div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700 transition-colors">
<span class="text-gray-500 dark:text-gray-400">Ask (Sell)</span>
<span class="font-medium text-gray-900 dark:text-gray-50" id="ask-price">...</span>
</div>
<div class="flex justify-between text-sm py-3">
<span class="text-gray-500 dark:text-gray-400">Market Status</span>
<span class="flex items-center gap-1 text-green-600 font-medium">
<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Open
</span>
</div>
</div>
</div>

<!-- TradingView Chart (Optimized with reveal and smooth transition) -->
<div class="lg:col-span-2 bg-white dark:bg-dark-800 rounded-3xl p-3 sm:p-6 border border-gray-200 dark:border-gray-700 shadow-xl reveal delay-100 transition-all duration-500 hover:shadow-2xl">
    <div class="flex justify-between items-center mb-4 px-3 sm:px-0">
        <h3 class="font-medium text-gray-900 dark:text-gray-50">Spot Price Performance (XAUMYRG)</h3>
    </div>
    <div class="relative h-80 sm:h-96 w-full">
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container h-full w-full">
            <div id="tradingview-chart" class="h-full w-full"></div>
            <script type="text/javascript">
                // This function is run via JS later to ensure the theme is correct
                function loadTradingViewWidget(theme) {
                    new TradingView.widget(
                    {
                    "autosize": true,
                    "symbol": "FX_IDC:XAUMYRG",
                    "interval": "D",
                    "timezone": "Asia/Kuala_Lumpur",
                    "theme": theme, // Set initial theme dynamically
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "tradingview-chart"
                    }
                    );
                }
            </script>
        </div>
        <!-- TradingView Widget END -->
    </div>
</div>

</div>
</div>
</section>

<!-- PRODUCT COLLECTION (Apple Style Showcase) -->
<section id="collection" class="py-24 bg-gray-100 dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="text-center mb-16 reveal">
<h2 class="text-5xl font-extrabold text-gray-900 dark:text-gray-50">The Collection</h2>
<p class="mt-4 text-xl text-gray-500 dark:text-gray-400">Purity and design, engineered for wealth preservation.</p>
</div>

<!-- Product sections will be injected here by JS -->
<div id="product-grid" class="space-y-16 lg:space-y-24">
</div>

</div>
</section>

<!-- FEATURES (Bento Grid) -->
<section id="investment" class="py-24 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-50 mb-16 reveal">Why Emas Binshiman?</h2>

<!-- Feature Grid with smooth hover transitions -->
<div class="grid grid-cols-1 md:grid-cols-3 grid-rows-2 gap-6 h-[800px] md:h-[600px]">

<!-- Feature 1: Large Left (Optimized with image hover scale) -->
<div class="md:col-span-2 md:row-span-2 relative group overflow-hidden rounded-3xl bg-gray-100 reveal transition-all duration-500 hover:shadow-2xl">
<img src="https://images.unsplash.com/photo-1610375461246-83c4850ed143?q=80&w=2187&auto=format&fit=crop" onerror="this.onerror=null;this.src='https://placehold.co/1000x800/fde89b/b45309?text=999.9+Gold+Bars';" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt="Gold Bars">
<div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/0 to-transparent"></div>
<div class="absolute bottom-8 left-8 text-white">
<h3 class="text-2xl font-bold mb-2 transition-transform duration-500 group-hover:translate-y-[-5px]">999.9 Purity Certified</h3>
<p class="text-gray-200 max-w-sm">Every piece comes with an internationally recognized certificate of authenticity.</p>
</div>
</div>

<!-- Feature 2: Top Right (Optimized with background and icon hover effects) -->
<div class="bg-gold-50 dark:bg-gold-900 p-8 rounded-3xl flex flex-col justify-center reveal delay-100 border border-gold-100 dark:border-gold-800 transition-all duration-500 hover:shadow-2xl hover:bg-gold-100 dark:hover:bg-gold-800 group">
<div class="w-12 h-12 bg-gold-100 dark:bg-gold-800 rounded-xl flex items-center justify-center mb-4 text-gold-600 dark:text-gold-300 transition-all duration-300 group-hover:scale-110">
<i data-lucide="shield-check" class="w-6 h-6"></i>
</div>
<h3 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-2">Secure Insured Shipping</h3>
<p class="text-sm text-gray-600 dark:text-gray-400">100% money back guarantee if lost in transit.</p>
</div>

<!-- Feature 3: Bottom Right (Optimized with background and icon hover effects) -->
<div class="bg-gray-900 dark:bg-dark-800 p-8 rounded-3xl flex flex-col justify-center text-white reveal delay-200 border border-transparent dark:border-gray-700 transition-all duration-500 hover:shadow-2xl hover:bg-black dark:hover:bg-dark-900 group">
<div class="w-12 h-12 bg-gray-800 dark:bg-gray-700 rounded-xl flex items-center justify-center mb-4 text-white transition-all duration-300 group-hover:scale-110">
<i data-lucide="refresh-cw" class="w-6 h-6"></i>
</div>
<h3 class="text-xl font-bold mb-2">Buyback Guarantee</h3>
<p class="text-sm text-gray-400">We buy back at the highest market rate, instantly and seamlessly.</p>
</div>

</div>
</div>
</section>

<!-- FOOTER -->
<footer class="bg-white dark:bg-dark-800 border-t border-gray-200 dark:border-gray-700 pt-16 pb-8">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex flex-col md:flex-row justify-between items-center mb-8">
<div class="flex items-center gap-2 mb-4 md:mb-0">
<div class="w-6 h-6 bg-gradient-to-br from-gold-300 to-gold-600 rounded flex items-center justify-center">
<i data-lucide="gem" class="text-white w-3 h-3"></i>
</div>
<span class="font-bold text-lg tracking-tight text-gray-900 dark:text-gray-50">Binshiman</span>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400">© <span id="year"></span> Emas Binshiman. All rights reserved.</p>
</div>
</div>
</footer>

<!-- CART MODAL (Slide Over) -->
<div id="cart-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden transition-opacity duration-300 opacity-0" onclick="toggleCart()"></div>

<div id="cart-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white dark:bg-dark-800 z-[60] transform translate-x-full transition-transform duration-500 shadow-2xl flex flex-col">
<!-- Cart Header -->
<div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white/95 dark:bg-dark-800/95 backdrop-blur-md sticky top-0">
<h2 class="text-xl font-bold text-gray-900 dark:text-gray-50">Your Bag</h2>
<button onclick="toggleCart()" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-900 rounded-full transition-colors">
<i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
</button>
</div>

<!-- Cart Items Container -->
<div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-6">
<!-- Empty State (Default) -->
<div class="flex flex-col items-center justify-center h-full text-center text-gray-500">
<i data-lucide="shopping-bag" class="w-12 h-12 mb-4 text-gray-300 dark:text-gray-700"></i>
<p>Your bag is empty.</p>
<button onclick="toggleCart(); window.location.href='#collection'" class="mt-4 text-gold-600 font-medium hover:underline transition-colors">Start Shopping</button>
</div>
</div>

<!-- Cart Footer -->
<div class="p-6 bg-gray-50 dark:bg-dark-900 border-t border-gray-100 dark:border-gray-700">
<div class="flex justify-between mb-2">
<span class="text-gray-500 dark:text-gray-400">Subtotal (Based on Live Rate)</span>
<span class="font-bold text-gray-900 dark:text-gray-50" id="cart-total">RM 0.00</span>
</div>
<p class="text-xs text-gray-400 dark:text-gray-500 mb-4">*Prices are locked for 5 minutes upon checkout.</p>
<!-- Checkout Button (Optimized for secure look and scale feedback) -->
<button onclick="checkout()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold transition-all duration-300 hover:bg-black hover:scale-[1.01] focus:outline-none focus:ring-4 ring-gold-500/50 flex items-center justify-center gap-2">
Secure Checkout <i data-lucide="lock" class="w-4 h-4"></i>
</button>
</div>
</div>

<!-- SOCIAL PROOF POPUP -->
<div id="fomo-popup" class="fixed bottom-6 left-6 z-40 bg-white dark:bg-dark-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 p-4 transform translate-y-32 transition-transform duration-500 flex items-center gap-4 max-w-sm">
<div class="w-12 h-12 bg-gray-100 dark:bg-dark-900 rounded-lg overflow-hidden flex-shrink-0">
<img src="https://images.unsplash.com/photo-1573408301185-9146fe634ad0?auto=format&fit=crop&q=80&w=100&h=100" onerror="this.onerror=null;this.src='https://placehold.co/100x100/fde89b/b45309?text=User';" class="w-full h-full object-cover">
</div>
<div>
<p class="text-sm text-gray-900 dark:text-gray-50 font-medium"><span id="fomo-name">Sarah</span> from KL just bought</p>
<p class="text-xs text-gold-600 font-bold" id="fomo-product">916 Gold Ring (2.5g)</p>
<p class="text-[10px] text-gray-400 dark:text-gray-500 mt-1">2 minutes ago</p>
</div>
<button onclick="this.parentElement.classList.add('translate-y-32')" class="absolute top-2 right-2 text-gray-300 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
<i data-lucide="x" class="w-3 h-3"></i>
</button>
</div>

<script>
// --- GLOBAL STATE ---
const BASE_PRICE = 560.00; 
let currentPrice = BASE_PRICE;
let previousPrice = BASE_PRICE;

let tradingViewWidgetLoaded = false;

// API Configuration for Live Price Fetching (using Google Search Grounding)
const MODEL = "gemini-2.5-flash-preview-09-2025";
const API_KEY = ""; // Key is provided by Canvas runtime
const BASE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
const MAX_RETRIES = 5;
const UPDATE_INTERVAL_MS = 60000; // Update every 60 seconds

// Products Database (Mock) - UPDATED FOR APPLE SHOWCASE STYLE
const products = [
    {
        id: 1,
        name: "Lunar Dragon Coin",
        tagline: "The Investment Masterpiece.",
        description: "Celebrating the auspicious Year of the Dragon, this 1 Ounce 999.9 fine gold coin is meticulously struck for the discerning collector. Limited edition.",
        weight: 31.10,
        type: "999.9",
        workmanship: 350,
        image: "https://images.unsplash.com/photo-1627883908208-d21a28a2a0a2?q=80&w=1500&auto=format&fit=crop",
        color: "bg-dark-900 text-white", // Deep Dark Background for high contrast
        textColor: "text-white"
    },
    {
        id: 2,
        name: "Eternity Bangle",
        tagline: "The Weight of Heritage.",
        description: "A timeless 916 gold bangle, designed for daily wear yet carrying the significant weight of an enduring asset. The perfect fusion of beauty and security.",
        weight: 18.00,
        type: "916",
        workmanship: 200,
        image: "https://images.unsplash.com/photo-1619197931327-0133c9cc9190?q=80&w=1500&auto=format&fit=crop",
        color: "bg-white dark:bg-dark-800", // Light/Dark Card Background
        textColor: "text-gray-900 dark:text-gray-50"
    },
    {
        id: 3,
        name: "Ultra Thin Bar",
        tagline: "Pure liquidity, pocket-sized.",
        description: "Our innovative 5g Ultra Thin Bar is sealed in secure veripack packaging, making it easy to store, transport, and liquidate. 999.9 investment grade.",
        weight: 5.00,
        type: "999.9",
        workmanship: 50,
        image: "https://images.unsplash.com/photo-1549488344-93be17039c3e?q=80&w=1500&auto=format&fit=crop",
        color: "bg-gold-50 dark:bg-gold-900", // Gold-themed background
        textColor: "text-gray-900 dark:text-gray-50"
    }
];

// Mock Cart - In a real app, this would be backed by Firestore
let cart = [];

// --- DOM ELEMENTS ---
const els = {
price: document.getElementById('current-price'),
bid: document.getElementById('bid-price'),
ask: document.getElementById('ask-price'),
change: document.getElementById('price-change'),
trendIcon: document.getElementById('trend-icon'),
productGrid: document.getElementById('product-grid'), 
cartCount: document.getElementById('cart-count'),
cartOverlay: document.getElementById('cart-overlay'),
cartDrawer: document.getElementById('cart-drawer'),
cartItems: document.getElementById('cart-items'),
cartTotal: document.getElementById('cart-total'),
visitors: document.getElementById('live-visitors'),
loading: document.getElementById('loading-indicator'),
todayText: document.getElementById('today-text'),
lastUpdated: document.getElementById('last-updated'),
themeToggle: document.getElementById('theme-toggle'),
};

// --- UTILITIES ---
function sleep(ms) {
return new Promise(resolve => setTimeout(resolve, ms));
}

// --- THEME LOGIC (Dark Mode) ---

function getInitialTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        return savedTheme;
    }
    // Check system preference
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
    }
    return 'light';
}

function applyTheme(theme) {
    const htmlElement = document.documentElement;
    const tvChartContainer = document.getElementById('tradingview-chart');

    // 1. Apply 'dark' class to the <html> element for Tailwind
    if (theme === 'dark') {
        htmlElement.classList.add('dark');
    } else {
        htmlElement.classList.remove('dark');
    }
    
    // 2. Update TradingView widget theme
    if (tradingViewWidgetLoaded && tvChartContainer) {
        const iframe = tvChartContainer.querySelector('iframe');
        
        // This attempts to update the TradingView widget's theme
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
                JSON.stringify({
                    method: 'set-theme',
                    args: [theme]
                }),
                "https://s3.tradingview.com"
            );
        } else {
            // Retry the theme application if iframe is not immediately available
            setTimeout(() => applyTheme(theme), 500);
        }
    }
}

function handleThemeToggle() {
    const htmlElement = document.documentElement;
    const isDark = htmlElement.classList.contains('dark');
    const newTheme = isDark ? 'light' : 'dark';
    
    // Apply and save the new theme
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
}


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. Initialize Theme
    const initialTheme = getInitialTheme();
    applyTheme(initialTheme);
    els.themeToggle.addEventListener('click', handleThemeToggle);

    // 2. Initialize Lucide Icons
    lucide.createIcons();
    
    // 3. Load TradingView Widget
    loadTradingViewWidget(initialTheme);
    tradingViewWidgetLoaded = true;

    // 4. Start Market Data Updates
    startRealtimeMarketUpdates();
    
    // 5. Render Products 
    renderProducts();
    
    // 6. Setup UX
    setupScrollAnimations();
    document.getElementById('year').textContent = new Date().getFullYear();

    // Randomize visitors for social proof
    setInterval(() => {
        const count = 80 + Math.floor(Math.random() * 50);
        els.visitors.textContent = `${count} Live`;
    }, 5000);

    // Start Social Proof
    setTimeout(showSocialProof, 5000);
});

// --- API FETCHING LOGIC (Gold Price) ---

async function fetchGoldPriceWithRetry(attempt = 0) {
    // Show loading indicator
    if (els.loading) els.loading.classList.remove('hidden');
    if (els.trendIcon) els.trendIcon.classList.add('hidden');
    if (els.change) els.change.classList.add('hidden');
    if (els.todayText) els.todayText.classList.add('hidden');
    if (els.lastUpdated) els.lastUpdated.textContent = 'Last update: Fetching...';


    if (attempt >= MAX_RETRIES) {
        console.error("Failed to fetch gold price after multiple retries. Using base price.");
        return BASE_PRICE;
    }

    const systemPrompt = "You are a specialized financial data parser. Your sole task is to find the current live price of 24K gold (999.9 purity) per gram in Malaysian Ringgit (MYR). Respond only with the numerical value of the price, formatted to exactly two decimal places, without any currency symbols, text, or extra characters. If the price cannot be reliably found, respond with the number 560.00.";
    const userQuery = "What is the live price of 24K gold (999.9) per gram in MYR right now?";

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        // Use Google Search grounding for live/real-time data
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        const response = await fetch(BASE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (text) {
            const price = parseFloat(text.trim());
            if (!isNaN(price) && price > 0) {
                return price;
            }
        }
        // If parsing failed or text was empty, fall through to retry
        throw new Error("Invalid or empty response from API.");

    } catch (error) {
        console.warn(`Attempt ${attempt + 1} failed:`, error.message);
        const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000); // Exponential backoff
        await sleep(delay);
        return fetchGoldPriceWithRetry(attempt + 1); // Retry recursively
    }
}

async function startRealtimeMarketUpdates() {
    const newPrice = await fetchGoldPriceWithRetry();

    previousPrice = currentPrice;
    currentPrice = newPrice;

    updateDashboard(currentPrice);
    updateProductPrices();
    updateCartTotal();

    // Hide loading indicator and show data
    if (els.loading) els.loading.classList.add('hidden');
    if (els.trendIcon) els.trendIcon.classList.remove('hidden');
    if (els.change) els.change.classList.remove('hidden');
    if (els.todayText) els.todayText.classList.remove('hidden');

    // Schedule the next update
    setTimeout(startRealtimeMarketUpdates, UPDATE_INTERVAL_MS);
}


function updateDashboard(price) {
    // Formatting helper
    const fmt = (n) => n.toFixed(2);

    // Apply a pulse effect to the price number when it updates
    if (els.price) {
        els.price.classList.remove('animate-[goldPulse_2s_ease-out]');
        els.price.textContent = fmt(price);
        // Re-add the class to restart the animation
        setTimeout(() => els.price.classList.add('animate-[goldPulse_2s_ease-out]'), 10);
    }

    // Update the last updated field
    if (els.lastUpdated) {
        els.lastUpdated.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
    }

    // Spread Calculation (Bid is lower, Ask is higher for the dealer)
    // Use 98% for Bid and 102% for Ask as a realistic mock spread
    if (els.bid) els.bid.textContent = fmt(price * 0.98); 
    if (els.ask) els.ask.textContent = fmt(price * 1.02); 

    // Calculate change percentage relative to the set BASE (560.00)
    const change = ((price - BASE_PRICE) / BASE_PRICE) * 100;
    if (els.change) els.change.textContent = `${change >= 0 ? '+' : ''}${fmt(change)}%`;

    // Color Logic
    const trendContainer = document.getElementById('price-change-container');
    if(trendContainer) {
        if(change >= 0) {
            trendContainer.className = "flex items-center gap-2 text-green-600 font-medium mb-4 transition-colors";
            if (els.trendIcon) els.trendIcon.setAttribute('data-lucide', 'trending-up');
        } else {
            trendContainer.className = "flex items-center gap-2 text-red-600 font-medium mb-4 transition-colors";
            if (els.trendIcon) els.trendIcon.setAttribute('data-lucide', 'trending-down');
        }
    }

    lucide.createIcons();
} 

// --- PRODUCT RENDERING (Apple Showcase Style) ---
function renderProducts() {
    els.productGrid.innerHTML = products.map((p, index) => {
        const estimatedPrice = (p.weight * currentPrice) + p.workmanship;
        const isImageLeft = index % 2 === 0; // Staggered alignment

        // Determine grid layout for text and image
        const gridClasses = isImageLeft 
            ? 'lg:grid-cols-[2fr_3fr] grid-flow-col' 
            : 'lg:grid-cols-[3fr_2fr] grid-flow-col';
        
        // Content for the text/info panel
        const infoPanel = `
            <div class="relative flex flex-col justify-center items-center p-8 sm:p-12 lg:p-16 text-center ${p.textColor}">
                <!-- Title Block -->
                <p class="text-sm font-semibold uppercase tracking-widest text-gold-400 mb-2 reveal delay-100">
                    ${p.type} Purity
                </p>
                <h3 class="text-4xl md:text-5xl lg:text-6xl font-extrabold tracking-tighter mb-4 reveal delay-200">
                    ${p.name}
                </h3>
                <h4 class="text-xl md:text-2xl font-medium mb-6 max-w-lg reveal delay-300">
                    ${p.tagline}
                </h4>
                <p class="text-base md:text-lg opacity-80 max-w-md mb-8 reveal delay-400">
                    ${p.description}
                </p>

                <!-- Purchase Details -->
                <div class="space-y-4 max-w-sm w-full reveal delay-400">
                    <div class="flex justify-center items-center gap-4">
                        <span class="text-3xl font-bold product-price-tag transition-colors duration-300" 
                              data-weight="${p.weight}" 
                              data-fee="${p.workmanship}">
                            RM ${estimatedPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </span>
                    </div>
                    
                    <!-- Buy Now Button (Optimized for scale feedback) -->
                    <button onclick="addToCart(${p.id})" 
                            class="w-full md:w-auto px-10 py-3 bg-gray-900 hover:bg-black text-white rounded-full font-bold transition-all duration-300 hover:scale-[1.05] shadow-lg shadow-gray-400/50 dark:shadow-none focus:outline-none focus:ring-4 ring-gold-500/50 flex items-center justify-center mx-auto gap-2">
                        Buy Now (${p.weight}g)
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                    <p class="text-xs opacity-70">Workmanship Fee: RM ${p.workmanship}</p>
                </div>
            </div>
        `;

        // Image Block
        const imagePanel = `
            <div class="relative w-full h-full min-h-[300px] lg:min-h-full">
                <img src="${p.image}" alt="${p.name}" 
                     onerror="this.onerror=null;this.src='https://placehold.co/1000x800/${p.color.includes('dark') ? '1c1c1e' : 'fef5cd'}/${p.textColor.includes('white') ? 'ffffff' : '111111'}?text=${p.name}';" 
                     class="w-full h-full object-cover lg:object-contain transition-transform duration-700 group-hover:scale-[1.02]">
            </div>
        `;

        return `
            <div class="product-showcase-block w-full rounded-3xl overflow-hidden shadow-2xl ${p.color} reveal group">
                <div class="grid grid-cols-1 ${gridClasses} h-full">
                    ${isImageLeft ? imagePanel + infoPanel : infoPanel + imagePanel}
                </div>
            </div>
        `;
    }).join('');
    
    lucide.createIcons();

    // Re-trigger reveal animation for new items
    setupScrollAnimations();
}

function updateProductPrices() {
document.querySelectorAll('.product-price-tag').forEach(tag => {
const weight = parseFloat(tag.dataset.weight);
const fee = parseFloat(tag.dataset.fee);
const price = (weight * currentPrice) + fee;
tag.textContent = `RM ${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
});
}

// --- CART SYSTEM ---
function addToCart(id) {
const product = products.find(p => p.id === id);

// Crucial: In a real app, this is where the price would be locked (item.lockedPrice = currentPrice)
cart.push({ ...product, addedAt: Date.now(), lockedPrice: currentPrice });

updateCartCount();
updateCartUI();

// Show cart automatically with a short delay for better UX flow
if(els.cartOverlay.classList.contains('hidden')) {
    setTimeout(toggleCart, 100);
}
}

function removeFromCart(index) {
cart.splice(index, 1);
updateCartCount();
updateCartUI();
}

function updateCartCount() {
if (els.cartCount) {
    els.cartCount.textContent = cart.length;
    els.cartCount.style.opacity = cart.length > 0 ? '1' : '0';
    // Add a small bounce/scale effect when count changes
    els.cartCount.classList.add('scale-150', 'bg-gold-600');
    setTimeout(() => els.cartCount.classList.remove('scale-150', 'bg-gold-600'), 300);
}
}

function updateCartUI() {
if (!els.cartItems || !els.cartTotal) return;

if (cart.length === 0) {
// Set empty state UI
els.cartItems.innerHTML = `
<div class="flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-400">
<i data-lucide="shopping-bag" class="w-12 h-12 mb-4 text-gray-300 dark:text-gray-700"></i>
<p>Your bag is empty.</p>
<button onclick="toggleCart(); window.location.href='#collection'" class="mt-4 text-gold-600 font-medium hover:underline transition-colors">Start Shopping</button>
</div>`;
els.cartTotal.textContent = "RM 0.00";
} else {
// Render cart items (uses the lockedPrice for display, for a realistic scenario)
els.cartItems.innerHTML = cart.map((item, index) => {
// Use the lockedPrice when calculating cart item price for stability
const price = (item.weight * item.lockedPrice) + item.workmanship; 
return `
<div class="flex gap-4 p-2 -mx-2 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-dark-900">
<div class="w-16 h-16 rounded-lg bg-gray-100 dark:bg-dark-900 overflow-hidden flex-shrink-0">
<img src="${item.image}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/fde89b/b45309?text=Emas';" class="w-full h-full object-cover">
</div>
<div class="flex-1">
<h4 class="font-medium text-gray-900 dark:text-gray-50 line-clamp-1">${item.name}</h4>
<p class="text-xs text-gray-500 dark:text-gray-400">${item.weight}g @ RM ${item.lockedPrice.toFixed(2)}/g</p>
<p class="text-sm font-bold text-gray-900 dark:text-gold-300 mt-1">RM ${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
</div>
<button onclick="removeFromCart(${index})" class="text-gray-400 hover:text-red-500 self-start transition-colors duration-200">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
`;
}).join('');
lucide.createIcons();
updateCartTotal();
}
}

function updateCartTotal() {
if (cart.length === 0) return;
if (!els.cartTotal) return; 

// Total calculation must use the lockedPrice for each item
const total = cart.reduce((sum, item) => sum + ((item.weight * item.lockedPrice) + item.workmanship), 0);
els.cartTotal.textContent = `RM ${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function toggleCart() {
const overlay = els.cartOverlay;
const drawer = els.cartDrawer;

if (!overlay || !drawer) return; 

if (overlay.classList.contains('hidden')) {
// Open
overlay.classList.remove('hidden');
setTimeout(() => overlay.classList.remove('opacity-0'), 10); // Fade in overlay
drawer.classList.remove('translate-x-full'); // Slide in drawer
} else {
// Close
overlay.classList.add('opacity-0'); // Fade out overlay
drawer.classList.add('translate-x-full'); // Slide out drawer
setTimeout(() => overlay.classList.add('hidden'), 500); // Hide overlay after transition
}
}

function checkout() {
if(cart.length === 0) return;

// Optimization: Direct to WhatsApp for personal closing
let message = `Hello Emas Binshiman, I would like to secure these items at the locked price:%0A%0A`;
let total = 0;

cart.forEach(item => {
const p = (item.weight * item.lockedPrice) + item.workmanship; // Use locked price
total += p;
message += `- ${item.name} (${item.weight}g @ RM ${item.lockedPrice.toFixed(2)}/g): RM ${p.toFixed(2)}%0A`;
});

message += `%0A*Total Locked Price: RM ${total.toFixed(2)}*`;

// Open WhatsApp - replace with actual number for production
window.open(`https://wa.me/60123456789?text=${message}`, '_blank');
}

// --- UX ENHANCEMENTS ---

// Social Proof Popup logic (Fomo)
function showSocialProof() {
const names = ["Sarah", "Ahmad", "Mei Ling", "Raj", "Jessica", "Wei"];
const items = ["916 Gold Ring", "Sauh Necklace", "10g Gold Bar", "Pulut Dakap Bracelet", "Lunar Dragon Coin"];

const popup = document.getElementById('fomo-popup');
const nameEl = document.getElementById('fomo-name');
const productEl = document.getElementById('fomo-product');

if (!popup || !nameEl || !productEl) return;

// Randomize name and product
nameEl.textContent = names[Math.floor(Math.random() * names.length)];
productEl.textContent = items[Math.floor(Math.random() * items.length)];

// Show popup (slide up)
popup.classList.remove('translate-y-32');

// Hide after 4 seconds (slide down)
setTimeout(() => {
popup.classList.add('translate-y-32');
}, 4000);

// Reschedule for a random time between 10s and 30s
setTimeout(showSocialProof, Math.random() * 20000 + 10000); 
}

// Scroll Reveal Animation setup
function setupScrollAnimations() {
const observer = new IntersectionObserver((entries) => {
entries.forEach(entry => {
if (entry.isIntersecting) {
entry.target.classList.add('active');
observer.unobserve(entry.target); // Stop observing once revealed
}
});
}, { threshold: 0.1 });

document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

// Mobile Menu Toggle
document.getElementById('mobile-menu-btn').addEventListener('click', () => {
document.getElementById('mobile-menu').classList.toggle('hidden');
});

// Sticky Nav Blur Effect on Scroll
window.addEventListener('scroll', () => {
const nav = document.getElementById('navbar');
if (nav) {
    if (window.scrollY > 20) {
        nav.classList.add('shadow-lg'); // Added shadow for more depth on scroll
    } else {
        nav.classList.remove('shadow-lg');
    }
}
});

</script>
</body>
</html>
