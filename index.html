<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emas Binshiman</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://unpkg.com/lucide@latest"></script>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
tailwind.config = {
    darkMode: 'class', // Manual toggling via class
    theme: {
        extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
                gold: {
                    50: '#fffbf0', 100: '#fef5cd', 200: '#fde89b', 300: '#fcd56d',
                    400: '#fbbf46', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
                    800: '#92400e', 900: '#78350f',
                },
                dark: {
                    900: '#0a0a0a', 800: '#1c1c1e',
                }
            },
            animation: {
                'float': 'float 6s ease-in-out infinite',
                'gold-pulse': 'goldPulse 4s ease-in-out infinite',
                'press': 'press 0.1s ease-out forwards',
            },
            keyframes: {
                float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                goldPulse: { '0%': { opacity: 1 }, '50%': { opacity: 0.95 }, '100%': { opacity: 1 } },
                press: { '0%': { transform: 'scale(1)' }, '100%': { transform: 'scale(0.98)' } }
            }
        }
    }
}
</script>

<style>
/* Base Styles */
body {
    -webkit-font-smoothing: antialiased;
}

/* Glassmorphism */
.glass {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}
.dark .glass {
    background: rgba(28, 28, 30, 0.85);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
}

/* VIEW TRANSITION API STYLES */
::view-transition-old(root),
::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
}

/* Scroll Reveal */
.reveal {
    opacity: 0;
    transform: translateY(30px) scale(0.98);
    transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.reveal.active { opacity: 1; transform: translateY(0) scale(1); }
.reveal.delay-100 { transition-delay: 0.1s; }
.reveal.delay-200 { transition-delay: 0.2s; }
.reveal.delay-300 { transition-delay: 0.3s; }

/* Custom Gradient Text */
.animated-hero-text {
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
    animation: goldPulse 4s ease-in-out infinite;
}

/* Product Card Hover */
.product-showcase-block {
    min-height: 700px;
    transition: transform 0.4s ease-out, box-shadow 0.4s ease-out, border 0.4s ease-out;
    border: 1px solid transparent;
}
.product-showcase-block:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid #fcd56d;
}
.dark .product-showcase-block:hover {
    box-shadow: 0 20px 40px rgba(255, 255, 255, 0.05);
    border: 1px solid #92400e;
}
</style>

<script>
    // Theme initialization must be here before DOM is loaded
    (function() {
        try {
            const savedTheme = localStorage.getItem('theme');
            const sysTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && sysTheme)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        } catch (e) {}
    })();
</script>
</head>

<body class="overflow-x-hidden bg-gray-100 dark:bg-dark-900 text-gray-900 dark:text-white">

<nav class="fixed w-full z-50 glass transition-all duration-300" id="navbar">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex-shrink-0 flex items-center gap-2 cursor-pointer transition-transform duration-300 hover:scale-[1.03]" onclick="window.scrollTo(0,0)">
<div class="w-8 h-8 bg-gradient-to-br from-gold-300 to-gold-600 rounded-lg flex items-center justify-center shadow-lg">
<i data-lucide="gem" class="text-white w-5 h-5"></i>
</div>
<span class="font-semibold text-xl tracking-tight">Binshiman</span>
</div>

<div class="hidden md:flex space-x-8 items-center">
<a href="#market" class="text-sm font-medium hover:text-gold-600 transition-colors">Live Market</a>
<a href="#collection" class="text-sm font-medium hover:text-gold-600 transition-colors">Collection</a>
<a href="#investment" class="text-sm font-medium hover:text-gold-600 transition-colors">Career</a>

<div class="flex items-center gap-2 bg-gray-100 dark:bg-dark-900 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all">
<span class="relative flex h-2 w-2">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
</span>
<span class="text-xs font-semibold text-gray-500 dark:text-gray-400" id="live-visitors">124 Live</span>
</div>
</div>

<div class="flex items-center gap-4">
<button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors active:scale-95">
    <i data-lucide="moon" class="w-5 h-5 hidden dark:block text-gold-300"></i>
    <i data-lucide="sun" class="w-5 h-5 block dark:hidden text-gray-700"></i>
</button>

<button class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors hover:scale-[1.1]" onclick="toggleCart()">
<i data-lucide="shopping-bag" class="w-5 h-5"></i>
<span id="cart-count" class="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center opacity-0 scale-75 transition-all">0</span>
</button>
<div class="md:hidden flex items-center">
<button id="mobile-menu-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-800">
<i data-lucide="menu" class="w-6 h-6"></i>
</button>
</div>
</div>
</div>
</div>

<div id="mobile-menu" class="hidden md:hidden bg-white/95 dark:bg-dark-800/95 backdrop-blur-xl border-t border-gray-100 dark:border-gray-700 absolute w-full z-40">
<div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
<a href="#market" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Market</a>
<a href="#collection" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Collection</a>
<a href="#investment" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Dealership</a>
</div>
</div>
</nav>

<section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
<div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gold-50 border border-gold-200 text-gold-800 text-sm font-medium mb-8 reveal hover:ring-2 ring-gold-500 transition-all">
<i data-lucide="sparkles" class="w-4 h-4"></i> New Collection in 2026
</div>

<h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 reveal delay-100">
Gold. <span class="animated-hero-text from-gold-500 to-gold-700">Redefined.</span>
</h1>

<p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500 dark:text-gray-400 reveal delay-200">
Premium savings security with Shariah-compliant. 
  <br>Designed for the modern era.
</p>

<div class="mt-10 flex justify-center gap-4 reveal delay-300">
<a href="#collection" class="px-8 py-4 bg-gray-900 text-white rounded-full font-medium transition-all hover:bg-black hover:scale-[1.05] shadow-lg shadow-gray-400/50 dark:shadow-none focus:outline-none focus:ring-4 ring-gold-500/50 active:animate-press">
View Collection
</a>
<a href="#market" class="px-8 py-4 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-700 rounded-full font-medium transition-all hover:bg-gray-50 dark:hover:bg-dark-900 hover:scale-[1.05] hover:border-gold-500/50 active:animate-press">
Track Prices
</a>
</div>
</div>

<div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full -z-10 opacity-30 pointer-events-none">
<div class="absolute top-[20%] left-[20%] w-72 h-72 bg-gold-300 rounded-full mix-blend-multiply filter blur-3xl animate-float"></div>
<div class="absolute top-[30%] right-[20%] w-72 h-72 bg-orange-200 rounded-full mix-blend-multiply filter blur-3xl animate-float" style="animation-delay: 2s"></div>
</div>
</section>

<section id="market" class="py-20 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

<div class="lg:col-span-1 bg-gray-50 dark:bg-dark-800 rounded-3xl p-8 border border-gray-100 dark:border-gray-700 shadow-xl reveal hover:shadow-2xl hover:border-gold-300 dark:hover:border-gold-700 transition-all">
<h2 class="text-2xl font-semibold mb-2">Live Gold Rate</h2>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Updates every 60s • 24K 999.9</p>

<div class="flex items-baseline gap-2 mb-2">
<span class="text-sm text-gray-500 dark:text-gray-400 font-medium">MYR</span>
<span id="current-price" class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-gold-300">...</span>
<span class="text-lg text-gray-400 dark:text-gray-500">/g</span>
</div>

<div id="price-change-container" class="flex items-center gap-2 text-green-600 font-medium mb-4">
    <div id="loading-indicator" class="flex items-center gap-2 text-gold-600 dark:text-gold-400 font-medium text-sm">
        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Fetching Live Data...
    </div>
    <i id="trend-icon" data-lucide="trending-up" class="w-5 h-5 hidden transition-all duration-300"></i>
    <span id="price-change" class="hidden">+0.00%</span>
    <span class="text-gray-400 dark:text-gray-500 text-sm font-normal hidden" id="today-text">Today</span>
</div>

<p class="text-xs text-gray-400 dark:text-gray-500 mb-8" id="last-updated">Last update: Loading...</p>

<div class="space-y-4">
    <div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700 transition-colors">
        <span class="text-gray-500 dark:text-gray-400">Bid (Buy)</span>
        <span class="font-medium text-gray-900 dark:text-gray-50" id="bid-price">...</span>
    </div>
    <div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700 transition-colors">
        <span class="text-gray-500 dark:text-gray-400">Ask (Sell)</span>
        <span class="font-medium text-gray-900 dark:text-gray-50" id="ask-price">...</span>
    </div>
    <div class="flex justify-between text-sm py-3">
        <span class="text-gray-500 dark:text-gray-400">Market Status</span>
        <span class="flex items-center gap-1 text-green-600 font-medium">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Open
        </span>
    </div>
</div>
</div>

<div class="lg:col-span-2 bg-white dark:bg-dark-800 rounded-3xl p-3 sm:p-6 border border-gray-200 dark:border-gray-700 shadow-xl reveal delay-100 hover:shadow-2xl transition-all">
    <div class="flex justify-between items-center mb-4 px-3 sm:px-0">
        <h3 class="font-medium">Spot Price Performance (XAUMYRG)</h3>
    </div>
    <div class="relative h-80 sm:h-96 w-full">
        <div class="tradingview-widget-container h-full w-full">
            <div id="tradingview-chart" class="h-full w-full"></div>
            <script type="text/javascript">
                function loadTradingViewWidget(theme) {
                    const container = document.getElementById('tradingview-chart');
                    container.innerHTML = ''; 
                    new TradingView.widget(
                    {
                    "autosize": true,
                    "symbol": "FX_IDC:XAUMYRG",
                    "interval": "D",
                    "timezone": "Asia/Kuala_Lumpur",
                    "theme": theme,
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "tradingview-chart"
                    }
                    );
                }
            </script>
        </div>
        </div>
</div>
</div>
</div>
</section>

<section id="collection" class="py-24 bg-gray-100 dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="text-center mb-16 reveal">
<h2 class="text-5xl font-extrabold">The Collection</h2>
<p class="mt-4 text-xl text-gray-500 dark:text-gray-400">Purity and design, engineered for wealth preservation.</p>
</div>
<div id="product-grid" class="space-y-16 lg:space-y-24"></div>
</div>
</section>

<section id="investment" class="py-24 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<h2 class="text-3xl font-bold text-center mb-16 reveal">Why Emas Binshiman?</h2>
<div class="grid grid-cols-1 md:grid-cols-3 grid-rows-2 gap-6 h-[800px] md:h-[600px]">
<div class="md:col-span-2 md:row-span-2 relative group overflow-hidden rounded-3xl bg-gray-100 reveal hover:shadow-2xl hover:scale-[1.01] transition-all">
<img src="https://images.unsplash.com/photo-1610375461246-83c4850ed143?q=80&w=2187&auto=format&fit=crop" onerror="this.onerror=null; this.src='https://via.placeholder.com/1500x1500?text=Premium+Gold';" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt="Investment grade gold bar">
<div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex flex-col justify-end p-8 text-white">
<i data-lucide="shield-check" class="w-8 h-8 text-gold-400 mb-3"></i>
<h3 class="text-3xl font-bold mb-2">Security & Trust</h3>
<p class="text-gray-300">All investments are certified 999.9 purity and stored in vault-grade facilities.</p>
</div>
</div>

<div class="relative group overflow-hidden rounded-3xl bg-gray-50 reveal delay-100 hover:shadow-xl hover:scale-[1.01] transition-all">
<img src="https://images.unsplash.com/photo-1589182373724-5d8fe894459e?q=80&w=1500&auto=format&fit=crop" onerror="this.onerror=null; this.src='https://via.placeholder.com/1000x1000?text=Realtime+Pricing';" class="w-full h-1/2 object-cover transition-transform duration-700 group-hover:scale-105" alt="Financial dashboard with chart">
<div class="p-6">
<i data-lucide="zap" class="w-6 h-6 text-gold-500 mb-2"></i>
<h3 class="text-xl font-bold">Real-time Pricing</h3>
<p class="text-gray-500 dark:text-gray-400 text-sm">Our rates sync instantly with global market movements.</p>
</div>
</div>

<div class="relative group overflow-hidden rounded-3xl bg-gold-50 reveal delay-200 hover:shadow-xl hover:scale-[1.01] transition-all">
<div class="p-6">
<i data-lucide="hand-coins" class="w-6 h-6 text-gold-700 mb-2"></i>
<h3 class="text-xl font-bold text-gray-900">Instant Liquidity</h3>
<p class="text-gray-700 text-sm">Sell your physical gold back at the highest market rate, instantly and seamlessly.</p>
</div>
</div>
</div>
</div>
</section>

<footer class="bg-white dark:bg-dark-800 border-t border-gray-200 dark:border-gray-700 pt-16 pb-8">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex flex-col md:flex-row justify-between items-center mb-8">
<div class="flex items-center gap-2 mb-4 md:mb-0">
<div class="w-6 h-6 bg-gradient-to-br from-gold-300 to-gold-600 rounded flex items-center justify-center">
<i data-lucide="gem" class="text-white w-3 h-3"></i>
</div>
<span class="font-bold text-lg tracking-tight">Binshiman</span>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400">© <span id="year"></span> Emas Binshiman. All rights reserved.</p>
</div>
</div>
</footer>

<div id="cart-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden transition-opacity duration-300 opacity-0" onclick="toggleCart()"></div>
<div id="cart-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white dark:bg-dark-800 z-[60] transform translate-x-full transition-transform duration-500 shadow-2xl flex flex-col">
<div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white/95 dark:bg-dark-800/95 backdrop-blur-md sticky top-0">
<h2 class="text-xl font-bold">Your Asset(s)</h2>
<button onclick="toggleCart()" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-900 rounded-full transition-colors active:animate-press"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="price-lock-timer-container" class="p-4 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 font-medium text-sm border-b border-red-200 dark:border-red-800 hidden items-center justify-center gap-2">
    <i data-lucide="timer" class="w-4 h-4"></i>
    Price Locked for <span id="price-lock-timer" class="font-extrabold text-red-800 dark:text-red-200">05:00</span>
</div>
<div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-6">
</div>
<div class="p-6 bg-gray-50 dark:bg-dark-900 border-t border-gray-100 dark:border-gray-700">
<div class="flex justify-between mb-2">
<span class="text-gray-500 dark:text-gray-400">Subtotal</span>
<span class="font-bold" id="cart-total">RM 0.00</span>
</div>
<button onclick="checkout()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold hover:scale-[1.01] active:animate-press flex items-center justify-center gap-2">Secure Checkout <i data-lucide="lock" class="w-4 h-4"></i></button>
</div>
</div>

<div id="fomo-popup" class="fixed bottom-6 left-6 z-40 bg-white dark:bg-dark-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 p-4 transition-transform duration-500 translate-y-32 flex items-start gap-4">
<img id="fomo-img" src="https://images.unsplash.com/photo-1573408301185-9146fe634ad0?auto=format&fit=crop&q=80&w=100" class="w-10 h-10 rounded-full object-cover flex-shrink-0" alt="Customer Avatar">
<div class="flex-1">
<p class="text-sm font-medium"><span id="fomo-name" class="font-bold">Ahmad L.</span> just bought <span id="fomo-product" class="text-gold-500 font-bold">The Binshiman Bar</span>.</p>
<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">1 minute ago</p>
</div>
<button onclick="this.parentElement.classList.add('translate-y-32')" class="absolute top-2 right-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors active:animate-press">
<i data-lucide="x" class="w-3 h-3"></i>
</button>
</div>

<script>
// --- GLOBAL STATE & CONFIG --- 
const BASE_PRICE = 560.00;
let currentPrice = BASE_PRICE;
let previousPrice = BASE_PRICE;

// Feature 4: Local Storage Key for Persistent Cart
const CART_STORAGE_KEY = 'binshiman_cart'; 
const LOCK_EXPIRY_KEY = 'binshiman_lock_expiry';

// Feature 2: Price Lock Configuration (5 minutes)
const LOCK_DURATION_MS = 5 * 60 * 1000; 
let priceLockInterval = null; 
let priceLockExpiry = null;

// API Configuration for Live Price Fetching (using Google Search Grounding)
const MODEL = "gemini-2.5-flash-preview-09-2025";
const API_KEY = ""; // Key is provided by Canvas runtime
const BASE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
const MAX_RETRIES = 5;
const UPDATE_INTERVAL_MS = 60000; // Update every 60 seconds

// Products Database (Mock)
const products = [
    { id: 1, name: "Gold Bar (10g)", tagline: "The Investment Masterpiece.", description: "describe... MAA Precious Metals Sdn. Bhd.", weight: 10.0, type: "999.9", workmanship: 0, image: "https://drive.google.com/file/d/1ZOC9JskK52whE-EIZ7_aIVlx-f_Stnc4/view?usp=drive_link", color: "bg-dark-900 text-white", textColor: "text-white" },
    { id: 2, name: "Gold Bar (10g)", tagline: "The Investment Masterpiece.", description: "describe... MAA Precious Metals Sdn. Bhd.", weight: 10.0, type: "999.9", workmanship: 0, image: "https://drive.google.com/file/d/1ZOC9JskK52whE-EIZ7_aIVlx-f_Stnc4/view?usp=drive_link", color: "bg-dark-900 text-white", textColor: "text-white" },
    { id: 3, name: "Gold Bar (10g)", tagline: "The Investment Masterpiece.", description: "describe... MAA Precious Metals Sdn. Bhd.", weight: 10.0, type: "999.9", workmanship: 0, image: "https://drive.google.com/file/d/1ZOC9JskK52whE-EIZ7_aIVlx-f_Stnc4/view?usp=drive_link", color: "bg-dark-900 text-white", textColor: "text-white" },
    { id: 4, name: "Gold Bar (10g)", tagline: "The Investment Masterpiece.", description: "describe... MAA Precious Metals Sdn. Bhd.", weight: 10.0, type: "999.9", workmanship: 0, image: "https://drive.google.com/file/d/1ZOC9JskK52whE-EIZ7_aIVlx-f_Stnc4/view?usp=drive_link", color: "bg-dark-900 text-white", textColor: "text-white" },
];

let cart = []; // Shopping cart state

// --- DOM ELEMENTS ---
const els = {
    themeToggle: document.getElementById('theme-toggle'),
    cartCount: document.getElementById('cart-count'),
    price: document.getElementById('current-price'),
    bid: document.getElementById('bid-price'),
    ask: document.getElementById('ask-price'),
    change: document.getElementById('price-change'),
    updated: document.getElementById('last-updated'),
    loading: document.getElementById('loading-indicator'),
    trendIcon: document.getElementById('trend-icon'),
    todayText: document.getElementById('today-text'),
    productGrid: document.getElementById('product-grid'),
    cartOverlay: document.getElementById('cart-overlay'),
    cartDrawer: document.getElementById('cart-drawer'),
    cartItems: document.getElementById('cart-items'),
    cartTotal: document.getElementById('cart-total'),
    checkoutBtn: document.getElementById('checkout-btn'),
    // Feature 2 Elements
    timerContainer: document.getElementById('price-lock-timer-container'),
    timerDisplay: document.getElementById('price-lock-timer'),
};

// --- HELPER FUNCTIONS ---
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// --- THEME & TRADINGVIEW LOGIC (Feature 3) ---
function getInitialTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) { return savedTheme; }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) { return 'dark'; }
    return 'light';
}

function applyTheme(theme) {
    const htmlElement = document.documentElement;
    const tvChartContainer = document.getElementById('tradingview-chart');

    // 1. Apply 'dark' class to the <html> element for Tailwind
    if (theme === 'dark') {
        htmlElement.classList.add('dark');
    } else {
        htmlElement.classList.remove('dark');
    }

    // 2. Update TradingView widget theme (handles initial load)
    if (tvChartContainer && tvChartContainer.querySelector('iframe')) {
        const iframe = tvChartContainer.querySelector('iframe');
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
                JSON.stringify({ method: 'set-theme', args: [theme] }),
                "https://s3.tradingview.com"
            );
        }
    } else {
        // If theme is changed before chart loads, re-init the widget
        if (typeof loadTradingViewWidget === 'function') {
            loadTradingViewWidget(theme);
        }
    }
}

function handleThemeToggle() {
    // Uses the existing logic and is now properly wired to the button
    const isDark = document.documentElement.classList.contains('dark');
    const newTheme = isDark ? 'light' : 'dark';
    
    // View Transition API for smooth transition (from ehe.html)
    if (document.startViewTransition) {
        document.startViewTransition(() => {
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
    } else {
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }
}
// Add event listener for the toggle button
els.themeToggle.addEventListener('click', handleThemeToggle);


// --- CART & PRICE LOCK LOGIC (Features 2 & 4) ---

function saveCart() {
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    localStorage.setItem(LOCK_EXPIRY_KEY, priceLockExpiry ? priceLockExpiry.toString() : '');
}

function loadCart() {
    const savedCart = localStorage.getItem(CART_STORAGE_KEY);
    const savedExpiry = localStorage.getItem(LOCK_EXPIRY_KEY);
    
    if (savedCart) {
        try {
            cart = JSON.parse(savedCart);
        } catch (e) {
            console.error("Failed to parse cart from storage.");
            cart = [];
        }
    }
    
    if (cart.length > 0 && savedExpiry) {
        priceLockExpiry = new Date(savedExpiry);
        startPriceLockTimer();
    }
    
    updateCartCount();
}

function startPriceLockTimer() {
    // Clear any existing timer
    if (priceLockInterval) {
        clearInterval(priceLockInterval);
    }
    
    // If no expiry is set (i.e., new cart items added), set one
    if (!priceLockExpiry || priceLockExpiry.getTime() <= Date.now()) {
        priceLockExpiry = new Date(Date.now() + LOCK_DURATION_MS);
        saveCart(); // Save new expiry time
    }
    
    // Show the timer container
    els.timerContainer.classList.remove('hidden');
    els.timerContainer.classList.add('flex');

    // Start countdown interval
    priceLockInterval = setInterval(() => {
        const now = Date.now();
        const timeRemaining = priceLockExpiry.getTime() - now;

        if (timeRemaining <= 0) {
            // Timer expired
            clearInterval(priceLockInterval);
            els.timerContainer.classList.remove('flex');
            els.timerContainer.classList.add('hidden');
            
            // Re-lock prices in the cart with the CURRENT market price
            relockCartPrices();
            
            // Reset expiry and cart state
            priceLockExpiry = null;
            saveCart();
            updateCartUI();
            
        } else {
            // Update the display
            const minutes = Math.floor(timeRemaining / 60000);
            const seconds = Math.floor((timeRemaining % 60000) / 1000);
            const displayTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            els.timerDisplay.textContent = displayTime;
            
            // Pulse animation for the last 30 seconds
            if (timeRemaining < 30000 && !els.timerContainer.classList.contains('animate-pulse')) {
                 els.timerContainer.classList.add('animate-pulse');
            } else if (timeRemaining >= 30000) {
                 els.timerContainer.classList.remove('animate-pulse');
            }
        }
    }, 1000);
}

function relockCartPrices() {
    // Update all cart item's locked prices to the current market price
    cart = cart.map(item => {
        const itemPrice = (item.weight * currentPrice) + item.workmanship;
        return {
            ...item,
            lockedPrice: currentPrice,
            estimatedPrice: itemPrice, // Recalculate estimated price
            isRelocked: true, // Optional flag for UI notification
        };
    });
    // Restart the timer with a new lock duration
    priceLockExpiry = new Date(Date.now() + LOCK_DURATION_MS);
    startPriceLockTimer();
}

function toggleCart() {
    if (els.cartOverlay.classList.contains('hidden')) {
        // Open
        els.cartOverlay.classList.remove('hidden', 'opacity-0');
        els.cartOverlay.classList.add('opacity-100');
        els.cartDrawer.classList.remove('translate-x-full');
        document.body.style.overflow = 'hidden'; 
        updateCartUI();
        if(cart.length > 0) {
            startPriceLockTimer(); // Start/continue timer on opening cart
        }
    } else {
        // Close
        els.cartOverlay.classList.remove('opacity-100');
        els.cartOverlay.classList.add('opacity-0');
        els.cartDrawer.classList.add('translate-x-full');
        document.body.style.overflow = ''; 
        setTimeout(() => els.cartOverlay.classList.add('hidden'), 300);
    }
}

function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;

    const estimatedPrice = (product.weight * currentPrice) + product.workmanship;

    cart.push({
        ...product,
        lockedPrice: currentPrice, // Lock the gold price per gram
        estimatedPrice: estimatedPrice,
        isRelocked: false,
    });

    // Reset and start a new lock period whenever a new item is added
    priceLockExpiry = new Date(Date.now() + LOCK_DURATION_MS); 
    startPriceLockTimer();

    saveCart();
    updateCartCount();
    updateCartUI();

    if(els.cartOverlay.classList.contains('hidden')) {
        setTimeout(toggleCart, 100);
    }
}

function removeFromCart(index) {
    cart.splice(index, 1);
    
    // Stop the timer if the cart becomes empty
    if(cart.length === 0) {
        clearInterval(priceLockInterval);
        priceLockExpiry = null;
        els.timerContainer.classList.remove('flex', 'animate-pulse');
        els.timerContainer.classList.add('hidden');
    }
    
    saveCart();
    updateCartCount();
    updateCartUI();
}

function updateCartCount() {
    if (els.cartCount) {
        els.cartCount.textContent = cart.length;
        els.cartCount.style.opacity = cart.length > 0 ? '1' : '0';
        els.cartCount.classList.add('scale-150', 'bg-gold-600');
        setTimeout(() => els.cartCount.classList.remove('scale-150', 'bg-gold-600'), 300);
    }
}

function updateCartUI() {
    if (!els.cartItems || !els.cartTotal) return;

    if (cart.length === 0) {
        els.cartItems.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-400">
                <i data-lucide="shopping-bag" class="w-12 h-12 mb-4 text-gray-300 dark:text-gray-700"></i>
                <p>Your bag is empty. Price lock inactive.</p>
                <button onclick="toggleCart(); window.location.href='#collection'" class="mt-4 text-gold-600 font-medium hover:underline transition-colors">Start Shopping</button>
            </div>
        `;
        els.cartTotal.textContent = "RM 0.00";
        els.timerContainer.classList.remove('flex', 'animate-pulse');
        els.timerContainer.classList.add('hidden');
        lucide.createIcons(); 
        return;
    }

    let total = 0;
    const itemsHtml = cart.map((item, index) => {
        // Ensure price is calculated based on the LOCKED price, not currentPrice
        const itemPrice = (item.weight * item.lockedPrice) + item.workmanship;
        total += itemPrice;

        // Message if price was relocked after timer expired
        const relockWarning = item.isRelocked ? 
            `<p class="text-[10px] text-orange-500 mt-0.5 font-bold flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Price Refreshed to Current Market Rate</p>` 
            : '';
        
        return `
            <div class="flex items-center gap-4 bg-gray-50 dark:bg-dark-900 p-4 rounded-xl border border-gray-100 dark:border-gray-700 transition-shadow duration-300 hover:shadow-md">
                <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                    <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-medium truncate">${item.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${item.weight}g ${item.type}</p>
                    <p class="text-sm font-bold text-gray-900 dark:text-gold-300 mt-1">RM ${itemPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p class="text-[10px] text-red-500 mt-0.5">Price Locked: RM ${item.lockedPrice.toFixed(2)}/g</p>
                    ${relockWarning}
                </div>
                <button onclick="removeFromCart(${index})" class="p-1 rounded-full text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors flex-shrink-0 active:animate-press">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `;
    }).join('');

    els.cartItems.innerHTML = itemsHtml;
    els.cartTotal.textContent = `RM ${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    
    lucide.createIcons();
}

function checkout() {
    if (!cart.length) return;

    let message = `Hello Emas Binshiman,%0A%0AI would like to secure these items at the locked price:%0A%0A`;
    let total = 0;
    cart.forEach(item => {
        const p = (item.weight * item.lockedPrice) + item.workmanship; 
        total += p;
        message += `- ${item.name} (${item.weight}g @ RM ${item.lockedPrice.toFixed(2)}/g): RM ${p.toFixed(2)}%0A`;
    });
    message += `%0A*Total Locked Price: RM ${total.toFixed(2)}*%0A`;
    message += `%0A_This price was locked at ${new Date().toLocaleTimeString()} and is subject to confirmation based on the price-lock timer._`;

    // Clear cart and timer after checkout to prevent issues
    cart = [];
    saveCart();
    updateCartCount();
    clearInterval(priceLockInterval);

    window.open(`https://wa.me/60166648004?text=${message}`, '_blank');
}

// --- MARKET DATA FETCHING ---
const systemPrompt = "Return the live price of 24K Gold in MYR as a single number (e.g., 280.50). Do not include any text, currency symbols, or formatting. Only the number.";
const userQuery = "What is the live price of XAUMYRG (Gold in MYR) right now?";

async function fetchGoldPriceWithRetry(attempt = 0) {
    if (attempt >= MAX_RETRIES) {
        console.error("Failed to fetch gold price after multiple retries.");
        return BASE_PRICE;
    }

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        const response = await fetch(BASE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (text) {
            const price = parseFloat(text.trim());
            if (!isNaN(price) && price > 0) {
                return price;
            }
        }
        throw new Error("Invalid or empty response from API.");

    } catch (error) {
        console.warn(`Attempt ${attempt + 1} failed:`, error.message);
        const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000); 
        await sleep(delay);
        return fetchGoldPriceWithRetry(attempt + 1);
    }
}

async function startRealtimeMarketUpdates() {
    const newPrice = await fetchGoldPriceWithRetry();

    previousPrice = currentPrice;
    currentPrice = newPrice;

    updateDashboard(currentPrice);
    updateProductPrices();

    // Check if the timer has expired since last update and cart is open
    if(cart.length > 0 && priceLockExpiry && priceLockExpiry.getTime() <= Date.now()) {
        // This handles cases where the cart was closed when the timer expired
        relockCartPrices();
        updateCartUI(); // Refresh UI with new relocked prices
    }

    if (els.loading) els.loading.classList.add('hidden');
    if (els.trendIcon) els.trendIcon.classList.remove('hidden');
    if (els.change) els.change.classList.remove('hidden');
    if (els.todayText) els.todayText.classList.remove('hidden');

    setTimeout(startRealtimeMarketUpdates, UPDATE_INTERVAL_MS);
}

function updateDashboard(price) {
    const fmt = (n) => n.toFixed(2);

    if (els.price) {
        els.price.textContent = fmt(price);
        els.price.classList.remove('animate-[goldPulse_2s_ease-out]');
        void els.price.offsetWidth; 
        els.price.classList.add('animate-[goldPulse_2s_ease-out]');
    }

    if (els.bid) els.bid.textContent = fmt(price * 0.98); 
    if (els.ask) els.ask.textContent = fmt(price * 1.02); 
    if (els.updated) els.updated.textContent = `Last update: ${new Date().toLocaleTimeString()}`;

    const change = ((price - previousPrice) / previousPrice) * 100;
    
    if (els.change) {
        els.change.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        
        const changeContainer = els.change.parentElement;
        if (changeContainer) {
            changeContainer.className = `flex items-center gap-2 font-medium mb-4 transition-colors ${change >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }
        
        if (els.trendIcon) {
            els.trendIcon.setAttribute('data-lucide', change >= 0 ? 'trending-up' : 'trending-down');
            lucide.createIcons();
        }
    }
}

// Recalculate the displayed price for each product block
function updateProductPrices() {
    const priceTags = document.querySelectorAll('.product-price-tag');
    priceTags.forEach(tag => {
        const weight = parseFloat(tag.getAttribute('data-weight'));
        const fee = parseFloat(tag.getAttribute('data-fee'));
        if (!isNaN(weight) && !isNaN(fee)) {
            const newPrice = (weight * currentPrice) + fee;
            tag.textContent = `RM ${newPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
    });
}

// --- PRODUCT RENDERING (Apple Showcase Style) ---
function renderProducts() {
    els.productGrid.innerHTML = products.map((p, index) => {
        const estimatedPrice = (p.weight * currentPrice) + p.workmanship;
        const isImageLeft = index % 2 === 0;

        const gridClasses = isImageLeft ? 'lg:grid-cols-[2fr_3fr] grid-flow-col' : 'lg:grid-cols-[3fr_2fr] grid-flow-col';

        const infoPanel = `
            <div class="relative flex flex-col justify-center items-center p-8 sm:p-12 lg:p-16 text-center ${p.textColor} ${isImageLeft ? 'lg:order-2' : 'lg:order-1'}">
                <p class="text-sm font-semibold uppercase tracking-widest text-gold-400 mb-2 reveal delay-100">
                    ${p.type} Purity
                </p>
                <h3 class="text-4xl md:text-5xl lg:text-6xl font-extrabold tracking-tighter mb-4 reveal delay-200">
                    ${p.name}
                </h3>
                <h4 class="text-xl md:text-2xl font-medium mb-6 max-w-lg reveal delay-300">
                    ${p.tagline}
                </h4>
                <p class="text-base md:text-lg opacity-80 max-w-md mb-8 reveal delay-400">
                    ${p.description}
                </p>
                <div class="space-y-4 max-w-sm w-full reveal delay-400">
                    <div class="flex justify-center items-center gap-4">
                        <span class="text-3xl font-bold product-price-tag transition-colors duration-300" data-weight="${p.weight}" data-fee="${p.workmanship}">
                            RM ${estimatedPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </span>
                    </div>
                    <button onclick="addToCart(${p.id})" class="w-full py-4 bg-gray-900 text-white dark:bg-gold-500 dark:text-gray-900 rounded-xl font-bold transition-all duration-300 hover:scale-[1.01] active:animate-press flex items-center justify-center gap-2">
                        Add to Bag <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                    </button>
                    <p class="text-xs opacity-70">
                        Workmanship Fee: RM ${p.workmanship.toFixed(2)}
                    </p>
                </div>
            </div>
        `;

        const imagePanel = `
            <div class="relative flex items-center justify-center p-8 sm:p-16 ${isImageLeft ? 'lg:order-1' : 'lg:order-2'}">
                <div class="absolute inset-0 z-0 opacity-20" style="background-image: url('${p.image}'); background-size: cover; filter: blur(40px);"></div>
                <img src="${p.image}" alt="${p.name}" class="relative z-10 w-full h-auto object-contain max-h-[500px] shadow-2xl rounded-xl transition-transform duration-500 group-hover:scale-[1.03]">
            </div>
        `;

        return `
            <div class="product-showcase-block w-full rounded-3xl overflow-hidden shadow-2xl ${p.color} reveal group">
                <div class="grid grid-cols-1 ${gridClasses} items-stretch min-h-[700px]">
                    ${isImageLeft ? imagePanel : ''}
                    ${infoPanel}
                    ${isImageLeft ? '' : imagePanel}
                </div>
            </div>
        `;
    }).join('');

    lucide.createIcons();
}

// --- SOCIAL PROOF (FOMO) LOGIC ---
const names = ["Ahmad L.", "Siti M.", "Tan K. H.", "Ravi N.", "Hana F."];
const items = ["Lunar Dragon Coin", "Binshiman Bar (10g)", "Fortune Piglet Charm", "Heirloom Bangle"];

function showSocialProof() {
    const popup = document.getElementById('fomo-popup');
    const nameEl = document.getElementById('fomo-name');
    const productEl = document.getElementById('fomo-product');

    if (!popup || !nameEl || !productEl) return;

    nameEl.textContent = names[Math.floor(Math.random() * names.length)];
    productEl.textContent = items[Math.floor(Math.random() * items.length)];

    popup.classList.remove('translate-y-32');

    setTimeout(() => {
        popup.classList.add('translate-y-32');
    }, 4000);

    setTimeout(showSocialProof, Math.random() * 20000 + 10000);
}

// --- UX/ANIMATION SETUP ---
function setupScrollAnimations() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('active');
                observer.unobserve(entry.target); 
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

document.getElementById('mobile-menu-btn').addEventListener('click', () => {
    document.getElementById('mobile-menu').classList.toggle('hidden');
});

window.addEventListener('scroll', () => {
    const navbar = document.getElementById('navbar');
    if (window.scrollY > 50) {
        navbar.classList.add('shadow-lg');
    } else {
        navbar.classList.remove('shadow-lg');
    }
});

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. Load Cart (Feature 4)
    loadCart();

    // 2. Initialize Theme (Feature 3 is handled in the head, but we re-apply here for consistency)
    const initialTheme = getInitialTheme();
    applyTheme(initialTheme);
    
    // 3. Initialize Lucide Icons
    lucide.createIcons();

    // 4. Load TradingView Widget
    loadTradingViewWidget(initialTheme);
    
    // 5. Start Market Data Updates
    startRealtimeMarketUpdates();

    // 6. Render Products
    renderProducts();

    // 7. Setup UX
    setupScrollAnimations();
    showSocialProof();

    // 8. Update Footer Year
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // 9. Initial cart count display
    updateCartCount();
});
</script>
</body>
</html>
