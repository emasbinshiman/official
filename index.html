<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emas Binshiman | Premium Gold Investment</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts: Inter (Closest free web-font to Apple's San Francisco) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- TradingView Script -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<!-- Tailwind Configuration -->
<script>
tailwind.config = {
    darkMode: 'class', // Manual toggling via class
    theme: {
        extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
                gold: {
                    50: '#fffbf0', 100: '#fef5cd', 200: '#fde89b', 300: '#fcd56d',
                    400: '#fbbf46', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
                    800: '#92400e', 900: '#78350f',
                },
                dark: {
                    900: '#0a0a0a', 800: '#1c1c1e',
                }
            },
            animation: {
                'float': 'float 6s ease-in-out infinite',
                'gold-pulse': 'goldPulse 4s ease-in-out infinite',
                'press': 'press 0.1s ease-out forwards',
            },
            keyframes: {
                float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                goldPulse: { '0%': { opacity: 1 }, '50%': { opacity: 0.95 }, '100%': { opacity: 1 } },
                press: { '0%': { transform: 'scale(1)' }, '100%': { transform: 'scale(0.98)' } }
            }
        }
    }
}
</script>

<style>
/* Base Styles */
body {
    -webkit-font-smoothing: antialiased;
    /* Removed global transition-colors to allow View Transition API to handle the visual switch efficiently */
}

/* Glassmorphism */
.glass {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}
.dark .glass {
    background: rgba(28, 28, 30, 0.85);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
}

/* VIEW TRANSITION API STYLES (The "Creative/Efficient" Fix) */
::view-transition-old(root),
::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
}

/* Scroll Reveal */
.reveal {
    opacity: 0;
    transform: translateY(30px) scale(0.98);
    transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.reveal.active { opacity: 1; transform: translateY(0) scale(1); }
.reveal.delay-100 { transition-delay: 0.1s; }
.reveal.delay-200 { transition-delay: 0.2s; }
.reveal.delay-300 { transition-delay: 0.3s; }

/* Custom Gradient Text */
.animated-hero-text {
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
    animation: goldPulse 4s ease-in-out infinite;
}

/* Product Card Hover */
.product-showcase-block {
    min-height: 700px;
    transition: transform 0.4s ease-out, box-shadow 0.4s ease-out, border 0.4s ease-out;
    border: 1px solid transparent;
}
.product-showcase-block:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid #fcd56d;
}
.dark .product-showcase-block:hover {
    box-shadow: 0 20px 40px rgba(255, 255, 255, 0.05);
    border: 1px solid #92400e;
}
</style>

<!-- CRITICAL FIX: Theme Script in Head to prevent Flash of Unstyled Content (FOUC) -->
<script>
    (function() {
        try {
            const savedTheme = localStorage.getItem('theme');
            const sysTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && sysTheme)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        } catch (e) {}
    })();
</script>
</head>

<body class="overflow-x-hidden bg-gray-100 dark:bg-dark-900 text-gray-900 dark:text-white">

<!-- NAVIGATION -->
<nav class="fixed w-full z-50 glass transition-all duration-300" id="navbar">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<!-- Logo -->
<div class="flex-shrink-0 flex items-center gap-2 cursor-pointer transition-transform duration-300 hover:scale-[1.03]" onclick="window.scrollTo(0,0)">
<div class="w-8 h-8 bg-gradient-to-br from-gold-300 to-gold-600 rounded-lg flex items-center justify-center shadow-lg">
<i data-lucide="gem" class="text-white w-5 h-5"></i>
</div>
<span class="font-semibold text-xl tracking-tight">Binshiman</span>
</div>

<!-- Desktop Menu -->
<div class="hidden md:flex space-x-8 items-center">
<a href="#market" class="text-sm font-medium hover:text-gold-600 transition-colors">Live Market</a>
<a href="#collection" class="text-sm font-medium hover:text-gold-600 transition-colors">Collection</a>
<a href="#investment" class="text-sm font-medium hover:text-gold-600 transition-colors">Career</a>

<!-- Live Traffic -->
<div class="flex items-center gap-2 bg-gray-100 dark:bg-dark-900 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all">
<span class="relative flex h-2 w-2">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
</span>
<span class="text-xs font-semibold text-gray-500 dark:text-gray-400" id="live-visitors">124 Live</span>
</div>
</div>

<!-- Icons -->
<div class="flex items-center gap-4">
<!-- DARK MODE TOGGLE (Target for View Transition) -->
<button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors active:scale-95">
    <i data-lucide="moon" class="w-5 h-5 hidden dark:block text-gold-300"></i>
    <i data-lucide="sun" class="w-5 h-5 block dark:hidden text-gray-700"></i>
</button>

<!-- Cart -->
<button class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors hover:scale-[1.1]" onclick="toggleCart()">
<i data-lucide="shopping-bag" class="w-5 h-5"></i>
<span id="cart-count" class="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center opacity-0 scale-75 transition-all">0</span>
</button>
<!-- Mobile Menu Btn -->
<div class="md:hidden flex items-center">
<button id="mobile-menu-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-800">
<i data-lucide="menu" class="w-6 h-6"></i>
</button>
</div>
</div>
</div>
</div>

<!-- Mobile Menu -->
<div id="mobile-menu" class="hidden md:hidden bg-white/95 dark:bg-dark-800/95 backdrop-blur-xl border-t border-gray-100 dark:border-gray-700 absolute w-full z-40">
<div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
<a href="#market" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Market</a>
<a href="#collection" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Collection</a>
<a href="#investment" class="block px-3 py-2 rounded-md font-medium hover:bg-gray-50 dark:hover:bg-dark-900">Career</a>
</div>
</div>
</nav>

<!-- HERO -->
<section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
<div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gold-50 border border-gold-200 text-gold-800 text-sm font-medium mb-8 reveal hover:ring-2 ring-gold-500 transition-all">
<i data-lucide="sparkles" class="w-4 h-4"></i> New Collection 2026
</div>

<h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 reveal delay-100">
Gold. <span class="animated-hero-text from-gold-500 to-gold-700">Redefined.</span>
</h1>

<p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500 dark:text-gray-400 reveal delay-200">
Real-time pricing. Premium savings security. Designed for the modern era.
</p>

<div class="mt-10 flex justify-center gap-4 reveal delay-300">
<a href="#collection" class="px-8 py-4 bg-gray-900 text-white rounded-full font-medium transition-all hover:bg-black hover:scale-[1.05] shadow-lg shadow-gray-400/50 dark:shadow-none focus:outline-none focus:ring-4 ring-gold-500/50 active:animate-press">
View Collection
</a>
<a href="#market" class="px-8 py-4 bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-700 rounded-full font-medium transition-all hover:bg-gray-50 dark:hover:bg-dark-900 hover:scale-[1.05] hover:border-gold-500/50 active:animate-press">
Track Prices
</a>
</div>
</div>

<div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full -z-10 opacity-30 pointer-events-none">
<div class="absolute top-[20%] left-[20%] w-72 h-72 bg-gold-300 rounded-full mix-blend-multiply filter blur-3xl animate-float"></div>
<div class="absolute top-[30%] right-[20%] w-72 h-72 bg-orange-200 rounded-full mix-blend-multiply filter blur-3xl animate-float" style="animation-delay: 2s"></div>
</div>
</section>

<!-- MARKET DATA -->
<section id="market" class="py-20 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- Live Price Card -->
<div class="lg:col-span-1 bg-gray-50 dark:bg-dark-800 rounded-3xl p-8 border border-gray-100 dark:border-gray-700 shadow-xl reveal hover:shadow-2xl hover:border-gold-300 dark:hover:border-gold-700 transition-all">
<h2 class="text-2xl font-semibold mb-2">Live Gold Rate</h2>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Updates every 60s • 24K 999.9</p>

<div class="flex items-baseline gap-2 mb-2">
<span class="text-sm text-gray-500 dark:text-gray-400 font-medium">MYR</span>
<span id="current-price" class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-gold-300">...</span>
<span class="text-lg text-gray-400">/g</span>
</div>

<div id="price-change-container" class="flex items-center gap-2 text-green-600 font-medium mb-4">
<div id="loading-indicator" class="flex items-center gap-2 text-gold-600 dark:text-gold-400 font-medium text-sm">
<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Analyzing Market...
</div>
<i id="trend-icon" data-lucide="trending-up" class="w-5 h-5 hidden"></i>
<span id="price-change" class="hidden">+0.00%</span>
</div>

<p class="text-xs text-gray-400 mb-8" id="last-updated">Initializing AI Feed...</p>

<div class="space-y-4">
<div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700">
<span class="text-gray-500 dark:text-gray-400">Bid (Buy)</span>
<span class="font-medium" id="bid-price">...</span>
</div>
<div class="flex justify-between text-sm py-3 border-b border-gray-200 dark:border-gray-700">
<span class="text-gray-500 dark:text-gray-400">Ask (Sell)</span>
<span class="font-medium" id="ask-price">...</span>
</div>
<div class="flex justify-between text-sm py-3">
<span class="text-gray-500 dark:text-gray-400">Market Status</span>
<span class="flex items-center gap-1 text-green-600 font-medium">
<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Open
</span>
</div>
</div>
</div>

<!-- TradingView Chart -->
<div class="lg:col-span-2 bg-white dark:bg-dark-800 rounded-3xl p-3 sm:p-6 border border-gray-200 dark:border-gray-700 shadow-xl reveal delay-100 hover:shadow-2xl transition-all">
    <div class="flex justify-between items-center mb-4 px-3 sm:px-0">
        <h3 class="font-medium">Spot Price Performance (XAUMYRG)</h3>
    </div>
    <div class="relative h-80 sm:h-96 w-full">
        <div class="tradingview-widget-container h-full w-full">
            <div id="tradingview-chart" class="h-full w-full"></div>
        </div>
    </div>
</div>

</div>
</div>
</section>

<!-- PRODUCTS -->
<section id="collection" class="py-24 bg-gray-100 dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="text-center mb-16 reveal">
<h2 class="text-5xl font-extrabold">The Collection</h2>
<p class="mt-4 text-xl text-gray-500 dark:text-gray-400">Purity and design, engineered for wealth preservation.</p>
</div>
<div id="product-grid" class="space-y-16 lg:space-y-24"></div>
</div>
</section>

<!-- FEATURES -->
<section id="investment" class="py-24 bg-white dark:bg-dark-900">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<h2 class="text-3xl font-bold text-center mb-16 reveal">Why Emas Binshiman?</h2>

<div class="grid grid-cols-1 md:grid-cols-3 grid-rows-2 gap-6 h-[800px] md:h-[600px]">
<div class="md:col-span-2 md:row-span-2 relative group overflow-hidden rounded-3xl bg-gray-100 reveal hover:shadow-2xl hover:scale-[1.01] transition-all">
<img src="https://images.unsplash.com/photo-1610375461246-83c4850ed143?q=80&w=2187&auto=format&fit=crop" onerror="this.onerror=null;this.src='https://placehold.co/1000x800/fde89b/b45309?text=999.9+Gold+Bars';" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt="Gold Bars">
<div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/0 to-transparent"></div>
<div class="absolute bottom-8 left-8 text-white">
<h3 class="text-2xl font-bold mb-2">999.9 Purity Certified</h3>
<p class="text-gray-200 max-w-sm">Every piece comes with an internationally recognized certificate of authenticity.</p>
</div>
</div>

<div class="bg-gold-50 dark:bg-gold-900 p-8 rounded-3xl flex flex-col justify-center reveal delay-100 border border-gold-100 dark:border-gold-800 hover:shadow-2xl hover:bg-gold-100 dark:hover:bg-gold-800 group hover:scale-[1.01] transition-all">
<div class="w-12 h-12 bg-gold-100 dark:bg-gold-800 rounded-xl flex items-center justify-center mb-4 text-gold-600 dark:text-gold-300 transition-all group-hover:scale-110">
<i data-lucide="shield-check" class="w-6 h-6"></i>
</div>
<h3 class="text-xl font-bold mb-2">Secure Insured Shipping</h3>
<p class="text-sm text-gray-600 dark:text-gray-400">100% money back guarantee if lost in transit.</p>
</div>

<div class="bg-gray-900 dark:bg-dark-800 p-8 rounded-3xl flex flex-col justify-center text-white reveal delay-200 border border-transparent dark:border-gray-700 hover:shadow-2xl hover:bg-black dark:hover:bg-dark-900 group hover:scale-[1.01] transition-all">
<div class="w-12 h-12 bg-gray-800 dark:bg-gray-700 rounded-xl flex items-center justify-center mb-4 text-white transition-all group-hover:scale-110">
<i data-lucide="refresh-cw" class="w-6 h-6"></i>
</div>
<h3 class="text-xl font-bold mb-2">Buyback Guarantee</h3>
<p class="text-sm text-gray-400">We buy back at the highest market rate, instantly and seamlessly.</p>
</div>
</div>
</div>
</section>

<!-- FOOTER -->
<footer class="bg-white dark:bg-dark-800 border-t border-gray-200 dark:border-gray-700 pt-16 pb-8">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex flex-col md:flex-row justify-between items-center mb-8">
<div class="flex items-center gap-2 mb-4 md:mb-0">
<div class="w-6 h-6 bg-gradient-to-br from-gold-300 to-gold-600 rounded flex items-center justify-center">
<i data-lucide="gem" class="text-white w-3 h-3"></i>
</div>
<span class="font-bold text-lg tracking-tight">Binshiman</span>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400">© <span id="year"></span> Emas Binshiman. All rights reserved.</p>
</div>
</div>
</footer>

<!-- CART DRAWER & MODALS -->
<div id="cart-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden transition-opacity duration-300 opacity-0" onclick="toggleCart()"></div>
<div id="cart-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white dark:bg-dark-800 z-[60] transform translate-x-full transition-transform duration-500 shadow-2xl flex flex-col">
<div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white/95 dark:bg-dark-800/95 backdrop-blur-md sticky top-0">
<h2 class="text-xl font-bold">Your Bag</h2>
<button onclick="toggleCart()" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-900 rounded-full transition-colors active:animate-press"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-6"></div>
<div class="p-6 bg-gray-50 dark:bg-dark-900 border-t border-gray-100 dark:border-gray-700">
<div class="flex justify-between mb-2">
<span class="text-gray-500 dark:text-gray-400">Subtotal</span>
<span class="font-bold" id="cart-total">RM 0.00</span>
</div>
<button onclick="checkout()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold hover:scale-[1.01] active:animate-press flex items-center justify-center gap-2">Secure Checkout <i data-lucide="lock" class="w-4 h-4"></i></button>
</div>
</div>

<!-- SOCIAL PROOF POPUP -->
<div id="fomo-popup" class="fixed bottom-6 left-6 z-40 bg-white dark:bg-dark-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 p-4 transform translate-y-32 transition-transform duration-500 flex items-center gap-4 max-w-sm">
<div class="w-12 h-12 bg-gray-100 dark:bg-dark-900 rounded-lg overflow-hidden flex-shrink-0">
<img id="fomo-img" src="" class="w-full h-full object-cover">
</div>
<div>
<p class="text-sm font-medium"><span id="fomo-name">User</span> just bought</p>
<p class="text-xs text-gold-600 font-bold" id="fomo-product">Item</p>
<p class="text-[10px] text-gray-400 mt-1">2 minutes ago</p>
</div>
<button onclick="this.parentElement.classList.add('translate-y-32')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-3 h-3"></i></button>
</div>

<script>
// --- GLOBAL STATE ---
const BASE_PRICE = 560.00; 
let currentPrice = BASE_PRICE;
const MODEL = "gemini-2.5-flash-preview-09-2025";
const API_KEY = ""; // Provided by Canvas
const MAX_RETRIES = 5;

// Mock Data
const products = [
    { id: 1, name: "Lunar Dragon Coin", tagline: "The Investment Masterpiece.", description: "1 Ounce 999.9 fine gold coin.", weight: 31.10, type: "999.9", workmanship: 350, image: "https://images.unsplash.com/photo-1627883908208-d21a28a2a0a2?q=80&w=1500&auto=format&fit=crop", color: "bg-dark-900 text-white", textColor: "text-white" },
    { id: 2, name: "Eternity Bangle", tagline: "The Weight of Heritage.", description: "Timeless 916 gold bangle.", weight: 18.00, type: "916", workmanship: 200, image: "https://images.unsplash.com/photo-1619197931327-0133c9cc9190?q=80&w=1500&auto=format&fit=crop", color: "bg-white dark:bg-dark-800", textColor: "text-gray-900 dark:text-gray-50" },
    { id: 3, name: "Ultra Thin Bar", tagline: "Pure liquidity, pocket-sized.", description: "5g Ultra Thin Bar.", weight: 5.00, type: "999.9", workmanship: 50, image: "https://images.unsplash.com/photo-1549488344-93be17039c3e?q=80&w=1500&auto=format&fit=crop", color: "bg-gold-50 dark:bg-gold-900", textColor: "text-gray-900 dark:text-gray-50" }
];
let cart = [];

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    loadTradingViewWidget(currentTheme);
    startRealtimeMarketUpdates();
    renderProducts();
    setupScrollAnimations();
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('theme-toggle').addEventListener('click', handleThemeToggle);
    setTimeout(showSocialProof, 5000);
});

// --- FIX: TRADINGVIEW WIDGET RELOAD ---
function loadTradingViewWidget(theme) {
    // Completely clear the container to force a re-render
    const container = document.getElementById('tradingview-chart');
    container.innerHTML = ''; 
    
    new TradingView.widget({
        "autosize": true,
        "symbol": "FX_IDC:XAUMYRG",
        "interval": "D",
        "timezone": "Asia/Kuala_Lumpur",
        "theme": theme,
        "style": "1",
        "locale": "en",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "allow_symbol_change": false,
        "container_id": "tradingview-chart"
    });
}

// --- CREATIVE: VIEW TRANSITION API (Dark Mode) ---
function handleThemeToggle(event) {
    const isDark = document.documentElement.classList.contains('dark');
    const newTheme = isDark ? 'light' : 'dark';

    // 1. Fallback for browsers without View Transitions
    if (!document.startViewTransition) {
        updateThemeClass(newTheme);
        return;
    }

    // 2. Geometry for the circular reveal
    const x = event.clientX;
    const y = event.clientY;
    const endRadius = Math.hypot(Math.max(x, innerWidth - x), Math.max(y, innerHeight - y));

    // 3. Start Transition
    const transition = document.startViewTransition(() => {
        updateThemeClass(newTheme);
    });

    // 4. Animate the clip-path
    transition.ready.then(() => {
        document.documentElement.animate(
            {
                clipPath: [
                    `circle(0px at ${x}px ${y}px)`,
                    `circle(${endRadius}px at ${x}px ${y}px)`
                ],
            },
            {
                duration: 500,
                easing: "ease-in-out",
                pseudoElement: "::view-transition-new(root)",
            }
        );
    });
}

function updateThemeClass(theme) {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
    localStorage.setItem('theme', theme);
    loadTradingViewWidget(theme); // Re-init widget
}

// --- AI: STRUCTURED JSON OUTPUT (Fix for Parsing Bugs) ---
async function fetchGoldPriceWithRetry(attempt = 0) {
    if (document.getElementById('loading-indicator')) document.getElementById('loading-indicator').classList.remove('hidden');

    const systemPrompt = "Return the live price of 24K Gold in MYR as a JSON object: { \"price\": number }.";
    const userQuery = "Live price of 24K gold (999.9) per gram in MYR?";
    
    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: { responseMimeType: "application/json" } // Force JSON
    };

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        const data = JSON.parse(jsonText); // Parse robust JSON
        
        if (data.price) return data.price;
        throw new Error("Invalid format");

    } catch (error) {
        console.warn(`Attempt ${attempt + 1} failed.`);
        if (attempt >= MAX_RETRIES) return BASE_PRICE;
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
        return fetchGoldPriceWithRetry(attempt + 1);
    }
}

async function startRealtimeMarketUpdates() {
    const newPrice = await fetchGoldPriceWithRetry();
    currentPrice = newPrice;
    updateDashboard(currentPrice);
    renderProducts(); // Re-render to update prices
    updateCartTotal();
    
    document.getElementById('loading-indicator')?.classList.add('hidden');
    document.getElementById('trend-icon')?.classList.remove('hidden');
    document.getElementById('price-change')?.classList.remove('hidden');
    
    setTimeout(startRealtimeMarketUpdates, 60000);
}

function updateDashboard(price) {
    const els = {
        price: document.getElementById('current-price'),
        bid: document.getElementById('bid-price'),
        ask: document.getElementById('ask-price'),
        change: document.getElementById('price-change'),
        updated: document.getElementById('last-updated')
    };

    if (els.price) els.price.textContent = price.toFixed(2);
    if (els.bid) els.bid.textContent = (price * 0.98).toFixed(2);
    if (els.ask) els.ask.textContent = (price * 1.02).toFixed(2);
    if (els.updated) els.updated.textContent = `Last update: ${new Date().toLocaleTimeString()}`;

    const change = ((price - BASE_PRICE) / BASE_PRICE) * 100;
    if (els.change) {
        els.change.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        els.change.parentElement.className = change >= 0 ? "flex items-center gap-2 text-green-600 font-medium mb-4" : "flex items-center gap-2 text-red-600 font-medium mb-4";
    }
}

// --- PRODUCT & CART LOGIC (Streamlined) ---
function renderProducts() {
    const grid = document.getElementById('product-grid');
    if (!grid) return;
    
    grid.innerHTML = products.map((p, i) => {
        const price = (p.weight * currentPrice) + p.workmanship;
        const isLeft = i % 2 === 0;
        
        return `
        <div class="product-showcase-block w-full rounded-3xl overflow-hidden shadow-2xl ${p.color} reveal group">
            <div class="grid grid-cols-1 ${isLeft ? 'lg:grid-cols-[2fr_3fr]' : 'lg:grid-cols-[3fr_2fr]'} h-full">
                ${isLeft ? `<div class="relative min-h-[300px]"><img src="${p.image}" class="w-full h-full object-cover"></div>` : ''}
                
                <div class="p-8 sm:p-12 text-center flex flex-col justify-center items-center ${p.textColor}">
                    <p class="text-sm font-semibold uppercase tracking-widest text-gold-400 mb-2">${p.type} Purity</p>
                    <h3 class="text-4xl font-extrabold mb-4">${p.name}</h3>
                    <p class="opacity-80 mb-8 max-w-md">${p.description}</p>
                    <span class="text-3xl font-bold mb-4">RM ${price.toFixed(2)}</span>
                    <button onclick="addToCart(${p.id})" class="px-10 py-3 bg-gray-900 text-white rounded-full font-bold hover:scale-105 transition-all shadow-lg shadow-gray-400/50 dark:shadow-none">Buy Now</button>
                </div>

                ${!isLeft ? `<div class="relative min-h-[300px]"><img src="${p.image}" class="w-full h-full object-cover"></div>` : ''}
            </div>
        </div>`;
    }).join('');
    lucide.createIcons();
}

function addToCart(id) {
    const p = products.find(x => x.id === id);
    cart.push({...p, lockedPrice: currentPrice});
    updateCartUI();
    toggleCart();
}

function updateCartUI() {
    const count = document.getElementById('cart-count');
    const items = document.getElementById('cart-items');
    
    count.textContent = cart.length;
    count.style.opacity = cart.length ? 1 : 0;
    
    if (!cart.length) {
        items.innerHTML = '<div class="text-center text-gray-500 mt-20">Bag is empty</div>';
        return;
    }

    items.innerHTML = cart.map((item, i) => `
        <div class="flex gap-4 p-2 hover:bg-gray-50 dark:hover:bg-dark-900 rounded-lg">
            <img src="${item.image}" class="w-16 h-16 rounded-lg object-cover">
            <div class="flex-1">
                <h4 class="font-medium">${item.name}</h4>
                <p class="text-xs text-gray-500">${item.weight}g @ RM ${item.lockedPrice.toFixed(2)}/g</p>
                <p class="font-bold">RM ${((item.weight * item.lockedPrice) + item.workmanship).toFixed(2)}</p>
            </div>
            <button onclick="cart.splice(${i},1);updateCartUI()" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
        </div>
    `).join('');
    
    lucide.createIcons();
    updateCartTotal();
}

function updateCartTotal() {
    const total = cart.reduce((sum, item) => sum + ((item.weight * item.lockedPrice) + item.workmanship), 0);
    document.getElementById('cart-total').textContent = `RM ${total.toFixed(2)}`;
}

function toggleCart() {
    const overlay = document.getElementById('cart-overlay');
    const drawer = document.getElementById('cart-drawer');
    const isClosed = overlay.classList.contains('hidden');
    
    if (isClosed) {
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        drawer.classList.remove('translate-x-full');
    } else {
        overlay.classList.add('opacity-0');
        drawer.classList.add('translate-x-full');
        setTimeout(() => overlay.classList.add('hidden'), 300);
    }
}

function checkout() {
    if(!cart.length) return;
    let msg = "Order Request:%0A";
    cart.forEach(i => msg += `- ${i.name}: RM ${((i.weight * i.lockedPrice) + i.workmanship).toFixed(2)}%0A`);
    window.open(`https://wa.me/60123456789?text=${msg}`, '_blank');
}

// --- UTILS ---
function setupScrollAnimations() {
    const obs = new IntersectionObserver(entries => {
        entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('active'); });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(el => obs.observe(el));
}

function showSocialProof() {
    const popup = document.getElementById('fomo-popup');
    const imgs = ["https://images.unsplash.com/photo-1573408301185-9146fe634ad0?auto=format&fit=crop&q=80&w=100", "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&q=80&w=100"];
    document.getElementById('fomo-img').src = imgs[Math.floor(Math.random()*imgs.length)];
    document.getElementById('fomo-name').textContent = ["Sarah", "Ahmed", "Wei"].sort(() => .5 - Math.random())[0];
    document.getElementById('fomo-product').textContent = products[Math.floor(Math.random()*products.length)].name;
    
    popup.classList.remove('translate-y-32');
    setTimeout(() => popup.classList.add('translate-y-32'), 4000);
    setTimeout(showSocialProof, Math.random() * 20000 + 10000);
}
</script>
</body>
</html>
