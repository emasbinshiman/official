<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emas Binshiman Fintech Platform - Professional Edition</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide Icons -->
    <script type="module">
        // Importing the library using the ESM bundle URL and named exports
        import { createIcons, icons } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        
        // Expose lucide globally for the main script to access
        window.lucide = { createIcons, icons };

        document.addEventListener('DOMContentLoaded', () => {
            createIcons({ icons });
        });
    </script>
    
    <!-- Firebase Integration for future use (placeholder/scaffolding) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Environment variables
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            // Set log level for debugging
            setLogLevel('Debug');
            
            // Handle authentication
            const authenticate = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase Auth successful. User:", auth.currentUser?.uid);
                } catch (error) {
                    console.error("Firebase Auth failed:", error);
                }
            };
            authenticate();
        }
    </script>

    <style>
        /* General scroll behavior to account for the fixed header height (4rem) */
        html {
            scroll-behavior: smooth;
            scroll-padding-top: 4rem; 
        }

        /* Define custom keyframes for animations */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 20s linear infinite;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.4; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 6s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }
        
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }
        .animate-spin-slow {
            animation: spinner 1.5s linear infinite;
        }

        /* Utility class to account for fixed header padding on scroll targets */
        .scroll-mt-16 {
            scroll-margin-top: 4rem; 
        }

        /* Enforce high contrast for the live price in the ticker */
        .price-text-display {
            font-size: 3rem; /* Larger text for the price */
            line-height: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-white font-sans text-gray-900 selection:bg-yellow-100 selection:text-yellow-900">

    <!-- Notification Toast Container -->
    <div id="notification-container" aria-live="polite" aria-atomic="true" class="fixed bottom-4 right-4 sm:bottom-8 sm:right-8 z-50 pointer-events-none"></div>

    <!-- Checkout Modal Container -->
    <div id="modal-container" role="dialog" aria-modal="true" aria-labelledby="modal-title" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in"></div>

    <!-- News Ticker -->
    <div class="bg-black text-white text-xs py-2 overflow-hidden whitespace-nowrap">
        <div class="inline-block animate-marquee px-4">
            <span class="mx-4">MARKET ALERT: Gold hits 3-month high.</span>
            <span class="mx-4 text-green-400">XAU/MYR &utri; 0.45%</span>
            <span class="mx-4">Silver demand increases in Asia sector.</span>
            <span class="mx-4 text-red-400">USD/MYR &vdar; 0.12%</span>
        </div>
    </div>

    <!-- Navbar (Fixed Top) -->
    <nav id="navbar" class="fixed top-0 w-full z-40 bg-white/80 backdrop-blur-md border-b border-gray-100 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="#hero" class="flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-yellow-600 rounded">
                    <span class="text-xl font-semibold tracking-tight text-gray-900">
                        Emas<span class="text-yellow-600">Binshiman</span>
                    </span>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="#market" class="nav-link text-sm font-medium text-gray-500 hover:text-black transition-colors">Market</a>
                    <a href="#products" class="nav-link text-sm font-medium text-gray-500 hover:text-black transition-colors">Trade</a>
                    <a href="#" class="nav-link text-sm font-medium text-gray-500 hover:text-black transition-colors">Vault</a>
                    <a href="#" class="nav-link text-sm font-medium text-gray-500 hover:text-black transition-colors">Learn</a>
                    <button id="cart-button" class="bg-black text-white text-sm px-4 py-2 rounded-full hover:bg-gray-800 transition-all flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-black">
                        <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                        <span>Bag (<span id="cart-count">0</span>)</span>
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-toggle" aria-controls="mobile-menu" aria-expanded="false" class="text-gray-500 hover:text-black p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-600">
                        <i data-lucide="menu" class="w-6 h-6" id="menu-icon"></i>
                        <i data-lucide="x" class="w-6 h-6 hidden" id="close-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-100 absolute w-full z-30 shadow-lg animate-fade-in">
            <div class="px-4 pt-4 pb-3 space-y-4">
                <a href="#market" class="mobile-nav-link block text-2xl font-semibold text-gray-900 hover:text-yellow-600">Market</a>
                <a href="#products" class="mobile-nav-link block text-2xl font-semibold text-gray-900 hover:text-yellow-600">Order</a>
                <a href="#" class="mobile-nav-link block text-2xl font-semibold text-gray-900 hover:text-yellow-600">Review</a>
                <a href="#" class="mobile-nav-link block text-2xl font-semibold text-gray-900 hover:text-yellow-600">Help</a>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
        <!-- Hero Section -->
        <section id="hero" class="relative pt-32 pb-16 sm:pt-40 sm:pb-24 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
                <h1 class="text-5xl sm:text-7xl font-semibold tracking-tight text-gray-900 mb-6">
                    Saves in <br class="hidden sm:block" />
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-yellow-500 to-yellow-700">
                        Timeless Value.
                    </span>
                </h1>
                <p class="mt-4 text-xl text-gray-500 max-w-2xl mx-auto font-light leading-relaxed">
                    Secure your future with 999.9 fine gold. Real-time purchasing, gold storage, buy-back and physical redemption. Simple. Secure.
                </p>
                <div class="mt-10 flex justify-center gap-4">
                    <button id="cta-button" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-medium hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl shadow-blue-300/50 focus:outline-none focus:ring-4 focus:ring-blue-300 active:scale-95">
                        Order Now
                    </button>
                    <a href="#products" class="text-blue-600 px-8 py-3 rounded-full text-lg font-medium hover:bg-blue-50 transition-all flex items-center border border-transparent hover:border-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-300 rounded-full">
                        Explore Products
                    </a>
                </div>
            </div>
            <!-- Abstract Background Element -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-yellow-100 rounded-full blur-3xl opacity-20 -z-10 animate-pulse-slow"></div>
        </section>

        <!-- Live Ticker Section -->
        <centre>
        <section id="market" class="py-12 bg-gray-50 scroll-mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8 text-center">
               <h2 class="text-3xl font-bold tracking-tight text-gray-900">Today's Gold Live Price</h2>
               <p class="text-sm text-gray-500 mt-2">Live chart data provided by TradingView. Spot price grounded by Google Search.</p>
            </div>
            
            <div class="max-w-4xl mx-auto px-4">
                 <!-- Live Ticker Component Output (Single Spot Price) -->
                <div id="live-ticker" class="mb-8">
                    <!-- Content will be injected by JavaScript -->
                    <div id="ticker-loading-message" class="text-center py-6 text-gray-500">
                        <div class="w-8 h-8 border-4 border-yellow-300 border-t-yellow-600 rounded-full inline-block animate-spin-slow"></div>
                        <p class="mt-2">Fetching authoritative spot price data...</p>
                    </div>
                </div>

                <!-- TradingView Chart Widget (Live Data) -->
                <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                    <div class="tradingview-widget-container" style="height:400px; width: 100%;">
                        <!-- TradingView Widget Script -->
                        <div class="tradingview-widget-container__widget" style="height:100%; width: 100%;"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                        {
                        "autosize": true,
                        "symbol": "FX_IDC:XAUMYRG",
                        "interval": "D",
                        "timezone": "Asia/Kuala_Lumpur",
                        "theme": "light",
                        "style": "1",
                        "locale": "en",
                        "allow_symbol_change": false,
                        "calendar": false,
                        "support_host": "https://www.tradingview.com"
                        }
                        </script>
                        <!-- NOTE: The TradingView widget is configured here for XAUUSD (Gold/USD). -->
                        <!-- The gold price calculation will convert it to MYR using the spot price fetched by the Gemini API. -->
                    </div>
                </div>

                <!-- Citation Section -->
                <div id="citation-panel" class="max-w-4xl mx-auto mt-6">
                    <div class="text-xs text-gray-500 border-t border-gray-200 pt-4">
                        <p class="font-semibold mb-1 flex items-center">
                            <i data-lucide="link-2" class="w-3 h-3 mr-1 text-yellow-600"></i>
                            Source Citations for Spot Price:
                        </p>
                        <ul id="sourcesList" class="space-y-1 pl-4 list-disc list-outside">
                            <!-- Sources will be injected by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </section></centre>

        <!-- Products Section -->
        <section id="products" class="py-12 max-w-7xl mx-auto px-4 sm:px-6 lg:lg:px-8 scroll-mt-16">
            <div class="flex justify-between items-end mb-10">
                <h2 class="text-3xl font-bold tracking-tight text-gray-900">Featured Products</h2>
                <a href="#" class="text-blue-600 font-medium hover:text-blue-700 flex items-center focus:outline-none focus:ring-2 focus:ring-blue-300 rounded-full">
                    View all <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </a>
            </div>
            
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Product Cards will be injected by JavaScript -->
            </div>
        </section>

        <!-- Feature Grid Section -->
        <section class="bg-white py-24">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <!-- Feature Items -->
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-yellow-50 rounded-2xl shadow-sm flex items-center justify-center mb-6 text-yellow-600 ring-4 ring-yellow-100">
                           <i data-lucide="shield-check" class="w-8 h-8" stroke-width="1.5"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Vault Security</h3>
                        <p class="text-gray-500 leading-relaxed max-w-xs">Your gold is stored in Grade A secure vaults with 24/7 surveillance and full insurance.</p>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-yellow-50 rounded-2xl shadow-sm flex items-center justify-center mb-6 text-yellow-600 ring-4 ring-yellow-100">
                            <i data-lucide="smartphone" class="w-8 h-8" stroke-width="1.5"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Mobile First</h3>
                        <p class="text-gray-500 leading-relaxed max-w-xs">Track your portfolio, buy, sell, and redeem instantly from your phone.</p>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-yellow-50 rounded-2xl shadow-sm flex items-center justify-center mb-6 text-yellow-600 ring-4 ring-yellow-100">
                            <i data-lucide="scroll-text" class="w-8 h-8" stroke-width="1.5"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Shariah Compliant</h3>
                        <p class="text-gray-500 leading-relaxed max-w-xs">Certified compliant trading with physical backing for every gram you own.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-50 border-t border-gray-200 pt-16 pb-8 mt-24">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-12">
                <div>
                    <h4 class="font-semibold text-gray-900 mb-4">Platform</h4>
                    <ul class="space-y-2 text-sm text-gray-500">
                        <li class="hover:text-gray-900 cursor-pointer">Live Prices</li>
                        <li class="hover:text-gray-900 cursor-pointer">Digital Gold</li>
                        <li class="hover:text-gray-900 cursor-pointer">Physical Store</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900 mb-4">Support</h4>
                    <ul class="space-y-2 text-sm text-gray-500">
                        <li class="hover:text-gray-900 cursor-pointer">Help Center</li>
                        <li class="hover:text-gray-900 cursor-pointer">Contact Us</li>
                        <li class="hover:text-gray-900 cursor-pointer">Shipping Status</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900 mb-4">Legal</h4>
                    <ul class="space-y-2 text-sm text-gray-500">
                        <li class="hover:text-gray-900 cursor-pointer">Privacy Policy</li>
                        <li class="hover:text-gray-900 cursor-pointer">Terms of Service</li>
                        <li class="hover:text-gray-900 cursor-pointer">Compliance</li>
                    </ul>
                </div>
                <div class="col-span-2 md:col-span-1">
                    <h4 class="font-semibold text-gray-900 mb-4">Connect</h4>
                    <div class="flex space-x-4 text-gray-500">
                         <i data-lucide="twitter" class="w-5 h-5 cursor-pointer hover:text-blue-400 transition-colors"></i>
                         <i data-lucide="facebook" class="w-5 h-5 cursor-pointer hover:text-blue-600 transition-colors"></i>
                         <i data-lucide="instagram" class="w-5 h-5 cursor-pointer hover:text-pink-500 transition-colors"></i>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-8 flex flex-col md:flex-row justify-between items-center text-xs text-gray-400">
                <p>&copy; <span id="current-year"></span> Emas Binshiman Sdn Bhd. All rights reserved.</p>
                <p class="mt-2 md:mt-0">Gold prices are indicative only. Physical products subject to availability.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- MOCK DATA ---
        const MOCK_PRODUCTS = [
            { id: 'p1', name: '10g Bunga Raya Gold Bar', purity: '999.9', weight: 10, image: 'https://images.unsplash.com/photo-1610375461490-67a338608314?q=80&w=200&auto=format&fit=crop', premium: 120 },
            { id: 'p2', name: '1 Dinar Coin (4.25g)', purity: '916', weight: 4.25, image: 'https://images.unsplash.com/photo-1579227114347-15d08fc37cae?auto=format&fit=crop&q=80&w=200', premium: 65 },
            { id: 'p3', name: '1kg Investment Cast Bar', purity: '999.9', weight: 1000, image: 'https://images.unsplash.com/photo-1605792657660-596af9009e82?auto=format&fit=crop&q=80&w=200', premium: 1500 }
        ];

        // --- STATE MANAGEMENT ---
        const FALLBACK_PRICE = 605.00; // Updated Fallback price (~RM600/g for 999.9 purity)
        let livePrice = 0.00; // Will be updated by API or fallback
        let previousPrice = 0.00; // For tracking change
        let cartCount = 0;
        let currentModalProduct = null;
        let priceLockInterval = null;
        let lastUpdatedTime = 'N/A';

        // --- API CONFIGURATION ---
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
        const FETCH_INTERVAL_MS = 30000; // Fetch new price every 30 seconds

        // --- DOM ELEMENTS ---
        const liveTickerEl = document.getElementById('live-ticker');
        const productGridEl = document.getElementById('product-grid');
        const sourcesList = document.getElementById('sourcesList');
        const tickerLoadingMessage = document.getElementById('ticker-loading-message');


        // --- UTILITY FUNCTIONS ---

        /**
         * Utility function for exponential backoff retry mechanism.
         */
        const withExponentialBackoff = async (func, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    // Do not log retries as errors in the console
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        /**
         * Renders the current live price ticker to the DOM.
         */
        function renderLiveTicker(sources = [], isFallback = false) {
            if (livePrice === 0 && !isFallback) return; // Wait until first fetch is successful

            const priceChange = livePrice - previousPrice;
            const direction = priceChange >= 0 ? 'up' : 'down';
            const colorClass = direction === 'up' ? 'text-green-600' : (direction === 'down' ? 'text-red-600' : 'text-gray-900');
            const icon = direction === 'up' ? 'trending-up' : 'trending-down';
            
            let percentageChange = 0;
            let changeDisplay;

            if (previousPrice > 0 && livePrice > 0) {
                percentageChange = ((Math.abs(priceChange) / previousPrice) * 100).toFixed(2);
                changeDisplay = `<span class="flex items-center text-sm font-medium ${colorClass} animate-fade-in">
                    <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>
                    ${percentageChange}%
                </span>`;
            } else if (isFallback) {
                changeDisplay = `<span class="text-sm font-medium text-gray-500">STATIC (Fallback)</span>`;
            } else {
                 changeDisplay = `<span class="text-sm font-medium text-gray-500">Initial Load</span>`;
            }


            liveTickerEl.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl border ${isFallback ? 'border-red-300' : 'border-gray-200'} p-6 flex flex-col sm:flex-row justify-between items-center transition-all duration-300 animate-fade-in">
                    <div class="flex items-center gap-4 mb-4 sm:mb-0">
                        <div class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center text-yellow-600 shadow-inner flex-shrink-0">
                            <i data-lucide="line-chart" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">999.9 Gold Spot Price (MYR/g)</p>
                            <div class="flex items-baseline gap-4">
                                <h2 class="price-text-display font-bold tracking-tight transition-colors duration-500 ${colorClass}">
                                    RM ${livePrice.toFixed(2)}
                                </h2>
                                <div class="flex flex-col items-end">
                                    ${changeDisplay}
                                    <p class="text-xs text-gray-400 mt-1">${isFallback ? 'Static Price' : 'Last Updated'}: ${lastUpdatedTime}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-x-6 gap-y-2 sm:gap-8 text-center sm:text-right text-sm pt-4 sm:pt-0">
                        <div><p class="text-xs text-gray-400 mb-1">Buy Spread</p><p class="font-semibold text-gray-900">4.5%</p></div>
                        <div><p class="text-xs text-gray-400 mb-1">Low (24h)</p><p class="font-semibold text-gray-900">598.00</p></div>
                        <div><p class="text-xs text-gray-400 mb-1">High (24h)</p><p class="font-semibold text-gray-900">608.00</p></div>
                    </div>
                </div>
            `;
            
            // Render citations
            sourcesList.innerHTML = ''; // Clear previous sources
            if (isFallback) {
                 sourcesList.innerHTML = `<li><span class="text-red-500 italic">Static fallback price (RM ${FALLBACK_PRICE.toFixed(2)}) is being used due to an API error. This is not a live quote.</span></li>`;
            } else if (sources.length > 0) {
                sources.forEach((source) => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 underline transition duration-150">${source.title || source.uri}</a>`;
                    sourcesList.appendChild(listItem);
                });
            } else {
                 sourcesList.innerHTML = '<li><span class="text-gray-500 italic">No explicit citation provided by the search grounding.</span></li>';
            }

            // Re-initialize Lucide icons after injecting HTML
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons({ icons: window.lucide.icons });
            }
        }

        /**
         * Renders all product cards to the DOM and attaches event listeners.
         */
        function renderProducts() {
            if (livePrice === 0) {
                productGridEl.innerHTML = '<p class="text-center text-gray-500 col-span-full">Loading product prices...</p>';
                return;
            }

            productGridEl.innerHTML = MOCK_PRODUCTS.map(product => {
                // Calculate item price based on the live/fallback price
                const totalPrice = (livePrice * product.weight) + product.premium;
                return `
                    <div class="group relative bg-white rounded-3xl p-6 border border-gray-100 transition-all hover:shadow-2xl hover:-translate-y-2 animate-fade-in">
                        <div class="aspect-square w-full overflow-hidden rounded-2xl bg-yellow-50 mb-6 flex items-center justify-center p-4">
                            <img src="${product.image}" alt="${product.name}"
                                class="h-48 w-48 object-contain mix-blend-multiply group-hover:scale-105 transition-transform duration-500"
                                onerror="this.onerror=null; this.src='https://placehold.co/192x192/fef3c7/a16207?text=Gold';"
                            />
                        </div>
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${product.name}</h3>
                                <p class="text-sm text-gray-500 font-medium mt-1">${product.purity} Fine Gold</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-yellow-700">RM ${totalPrice.toFixed(2)}</p>
                                <p class="text-xs text-green-600 flex items-center justify-end gap-1">
                                    <i data-lucide="check-circle" class="w-3 h-3 fill-green-500 text-white"></i>
                                    In Stock
                                </p>
                            </div>
                        </div>
                        <button data-product-id="${product.id}"
                            class="buy-button mt-6 w-full bg-yellow-600 text-white py-3 rounded-xl font-medium hover:bg-yellow-700 transition-colors flex items-center justify-center gap-2 active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-yellow-300"
                            aria-label="Buy ${product.name} for RM ${totalPrice.toFixed(2)}"
                        >
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            Buy Now
                        </button>
                    </div>
                `;
            }).join('');

            // Attach event listeners to all 'Buy Now' buttons
            document.querySelectorAll('.buy-button').forEach(button => {
                button.removeEventListener('click', handleBuyClick); // Remove old listener first
                button.addEventListener('click', handleBuyClick);
            });
            // Re-initialize Lucide icons for products
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons({ icons: window.lucide.icons });
            }
        }

        /**
         * Fetches the real-time gold price using the Gemini API with Google Search grounding.
         */
        const fetchGoldPrice = async () => {
            // Show loading state initially
            liveTickerEl.innerHTML = '';
            tickerLoadingMessage.style.display = 'block';
            sourcesList.innerHTML = '<li><span class="text-gray-400">Requesting real-time financial data...</span></li>';
            
            // IMPROVED USER QUERY for better accuracy on MYR 999.9 price
            const userQuery = "What is the real-time physical gold 999.9 (24K) retail selling price in Malaysian Ringgit (MYR) per gram today from a legitimate source like banks or major dealers? Provide the most recent data.";
            
            // System prompt is strict to force a clean number output
            const systemPrompt = "You are a financial data assistant. Given the user query, find the current physical gold price per gram in MYR. Respond only with the price value as a number (e.g., '605.50'). Do not include currency symbols, units, explanatory text, or any introductory/concluding remarks. The output must be purely numeric (e.g., 605.50).";
            const apiKey = ""; // API key is handled by the Canvas environment

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable search grounding for live data
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await withExponentialBackoff(() => fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("API call was successful but did not retrieve a valid price text response.");
                }

                // 1. Extract and validate the generated price text
                const priceText = candidate.content.parts[0].text.trim();
                const newPrice = parseFloat(priceText);
                
                // Check for a reasonable, modern price range for MYR/g (now expecting > 500)
                if (isNaN(newPrice) || newPrice <= 500 || newPrice > 1000) { 
                    throw new Error(`Invalid or suspicious price received: "${priceText}". Expected value in 500-1000 range. Falling back.`);
                }

                // Update state
                previousPrice = livePrice;
                livePrice = newPrice;
                lastUpdatedTime = new Date().toLocaleTimeString('en-MY', { hour: '2-digit', minute: '2-digit' });

                // 2. Extract and display grounding sources for citation
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                // Render UI with new data
                tickerLoadingMessage.style.display = 'none';
                renderLiveTicker(sources, false);
                renderProducts();

                console.log(`[Success] Live price updated to: RM ${livePrice.toFixed(2)}`);

            } catch (error) {
                // --- FALLBACK LOGIC ---
                console.error("[CRITICAL] Error fetching live gold price. Using static fallback.", error);

                // If previousPrice is still 0 (first attempt failed), set livePrice to fallback
                if (livePrice === 0) {
                    previousPrice = FALLBACK_PRICE;
                    livePrice = FALLBACK_PRICE;
                    lastUpdatedTime = new Date().toLocaleTimeString('en-MY', { hour: '2-digit', minute: '2-digit' });
                }
                
                // Render UI with fallback status
                tickerLoadingMessage.style.display = 'none';
                renderLiveTicker([], true); // Pass true to signal it's a fallback
                renderProducts();
            }
        };


        // --- EVENT HANDLERS ---
        
        /**
         * Event handler for 'Buy Now' button.
         */
        function handleBuyClick(e) {
            if (livePrice === 0) {
                showNotification("Price data is still loading. Please wait a moment.", true);
                return;
            }
            const productId = e.currentTarget.dataset.productId;
            const product = MOCK_PRODUCTS.find(p => p.id === productId);
            const price = (livePrice * product.weight) + product.premium;
            showCheckoutModal(product, price);
        }

        /**
         * Shows the floating notification toast.
         */
        function showNotification(message, isError = false) {
            const container = document.getElementById('notification-container');
            const icon = isError ? 'alert-triangle' : 'check-circle';
            const bgColor = isError ? 'bg-red-600' : 'bg-green-600';
            
            container.innerHTML = `
                <div role="${isError ? 'alert' : 'status'}" class="pointer-events-auto bg-gray-900 text-white px-6 py-4 rounded-xl shadow-2xl animate-fade-in flex items-center gap-3">
                    <div class="${bgColor} rounded-full p-1"><i data-lucide="${icon}" class="w-3 h-3 text-white fill-white"></i></div>
                    ${message}
                </div>
            `;

            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons({ icons: window.lucide.icons });
            }

            // Automatically hide after 4 seconds
            setTimeout(() => {
                const notificationEl = container.querySelector('div');
                if (notificationEl) {
                    notificationEl.classList.remove('animate-fade-in');
                    notificationEl.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => container.innerHTML = '', 500);
                }
            }, 4000);
        }

        /**
         * Renders and shows the Checkout Modal.
         */
        function showCheckoutModal(product, price) {
            currentModalProduct = product;
            const modalContainer = document.getElementById('modal-container');
            
            // Show modal structure
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');

            let timeLeft = 300; // 5 minutes

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`; 
            };

            const renderModalContent = (time) => {
                const total = price + 10;
                return `
                    <!-- Modal Card -->
                    <div id="checkout-card" class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-slide-up" role="document">
                        <!-- Header with Countdown -->
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h2 id="modal-title" class="text-lg font-semibold text-gray-900">Confirm Order</h2>
                            <div class="flex items-center gap-2 text-red-600 bg-red-50 px-3 py-1 rounded-full border border-red-300">
                                <i data-lucide="lock" class="w-3 h-3"></i>
                                <span class="text-xs font-medium text-red-600">Price Locked</span>
                                <span id="time-left" class="text-sm font-mono font-bold">${formatTime(time)}</span>
                            </div>
                        </div>

                        <div class="p-8">
                            <div class="flex gap-4 mb-6 items-center">
                                <div class="w-16 h-16 bg-yellow-50 rounded-xl overflow-hidden flex-shrink-0 shadow-inner">
                                <img src="${product.image}" alt="${product.name} thumbnail" class="w-full h-full object-cover mix-blend-multiply" 
                                    onerror="this.onerror=null; this.src='https://placehold.co/64x64/fef3c7/a16207?text=Gold';"
                                />
                                </div>
                                <div>
                                <h3 class="font-bold text-gray-900">${product.name}</h3>
                                <p class="text-sm text-gray-500">${product.weight}g â€¢ ${product.purity}</p>
                                </div>
                            </div>

                            <div class="space-y-3 mb-8 border border-gray-100 p-4 rounded-xl">
                                <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Item Price (RM ${livePrice.toFixed(2)}/g)</span>
                                <span class="font-medium">RM ${price.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Processing Fee</span>
                                <span class="font-medium">RM 10.00</span>
                                </div>
                                <div class="h-px bg-gray-200 my-2"></div>
                                <div class="flex justify-between text-xl font-extrabold text-gray-900">
                                <span>Total Payable</span>
                                <span>RM ${total.toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <button id="confirm-payment-btn" class="w-full bg-yellow-600 text-white py-3.5 rounded-xl font-semibold hover:bg-yellow-700 transition-colors shadow-lg shadow-yellow-200 focus:outline-none focus:ring-4 focus:ring-yellow-300 active:scale-[0.99]">
                                <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                                Confirm Payment
                                </button>
                                <button id="cancel-payment-btn" class="w-full bg-white text-gray-500 py-3.5 rounded-xl font-medium border border-gray-200 hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                                Cancel Order
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-6 py-3 text-center text-xs text-gray-400">
                            Secure 256-bit SSL Encrypted Transaction
                        </div>
                    </div>
                    <!-- End Modal Card -->
                `;
            };

            // Initial render
            modalContainer.innerHTML = renderModalContent(timeLeft);
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons({ icons: window.lucide.icons });
            }

            // Set up timer
            const timerEl = document.getElementById('time-left');
            const confirmBtn = document.getElementById('confirm-payment-btn');
            
            const timer = setInterval(() => {
                timeLeft = timeLeft > 0 ? timeLeft - 1 : 0;
                if (timerEl) {
                    timerEl.textContent = formatTime(timeLeft);
                }
                
                // Disable button and end transaction if time runs out
                if (timeLeft === 0) {
                    clearInterval(timer);
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = 'Price Expired';
                        confirmBtn.classList.remove('hover:bg-yellow-700', 'bg-yellow-600');
                        confirmBtn.classList.add('bg-gray-400');
                    }
                    showNotification("Order timed out. Price lock expired. Please restart the process.", true);
                }
            }, 1000);

            priceLockInterval = timer;
            
            // Attach new listeners
            document.getElementById('confirm-payment-btn').addEventListener('click', confirmOrder);
            document.getElementById('cancel-payment-btn').addEventListener('click', closeCheckoutModal);

            // Close modal when clicking outside of the card
            document.getElementById('modal-container').addEventListener('click', (e) => {
                const checkoutCard = document.getElementById('checkout-card');
                if (checkoutCard && !checkoutCard.contains(e.target)) {
                    closeCheckoutModal();
                }
            });

            // Close modal when pressing ESC key
            document.addEventListener('keydown', handleEscapeKey);
        }

        /**
         * Handler for the Escape key press event.
         */
        function handleEscapeKey(e) {
            if (e.key === 'Escape' || e.key === 'Esc') {
                closeCheckoutModal();
            }
        }

        /**
         * Hides the Checkout Modal and clears the price lock timer.
         */
        function closeCheckoutModal() {
            if (priceLockInterval) {
                clearInterval(priceLockInterval);
            }
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
            currentModalProduct = null;
            
            // Remove the global keydown listener
            document.removeEventListener('keydown', handleEscapeKey);
        }

        /**
         * Confirms the order, updates cart count, and shows a notification.
         */
        function confirmOrder() {
            // Check if the price has expired before confirming
            const timerEl = document.getElementById('time-left');
            if (timerEl && timerEl.textContent === '0:00') {
                 showNotification("Cannot confirm. Price lock has expired.", true);
                 return;
            }

            closeCheckoutModal();
            cartCount++;
            document.getElementById('cart-count').textContent = cartCount;
            showNotification(`Order for ${currentModalProduct.name} placed successfully!`);
        }

        /**
         * Toggles the mobile menu visibility.
         */
        function toggleMobileMenu() {
            const menuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');

            const isHidden = mobileMenu.classList.toggle('hidden');
            
            menuToggle.setAttribute('aria-expanded', !isHidden);
            menuIcon.classList.toggle('hidden', !isHidden);
            closeIcon.classList.toggle('hidden', isHidden);
        }


        // --- INITIALIZATION AND EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial call to fetch the price and set up the interface
            fetchGoldPrice();

            // Set up interval for subsequent price updates
            setInterval(fetchGoldPrice, FETCH_INTERVAL_MS);

            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Initial mock product render (will be updated by fetchGoldPrice shortly)
            renderProducts();

            // --- NAVIGATION LISTENERS ---
            
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-toggle').addEventListener('click', toggleMobileMenu);

            // Close mobile menu when a link inside it is clicked
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (!document.getElementById('mobile-menu').classList.contains('hidden')) {
                        toggleMobileMenu();
                    }
                });
            });

            // CTA Button Scroll
            document.getElementById('cta-button').addEventListener('click', () => {
                // Scroll to the products section
                document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
            });
            
        });
    </script>

</body>
</html>
